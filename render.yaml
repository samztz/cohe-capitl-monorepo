# ============================================
# Render.com Blueprint Configuration
# Cohe Capital Insurance Platform
# ============================================
#
# DEPLOYMENT INSTRUCTIONS:
# 1. Push this file to your GitHub repository root
# 2. Go to https://dashboard.render.com/blueprints
# 3. Click "New Blueprint Instance"
# 4. Connect your GitHub repo - Render auto-detects this file
# 5. Fill in required secret environment variables
# 6. Click "Apply" to deploy all services at once
#
# REQUIRED SECRETS (set during Blueprint creation):
# - NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID (get from https://cloud.reown.com/)
# - JWT_SECRET (generate: openssl rand -base64 32)
# - JWT_REFRESH_SECRET (generate: openssl rand -base64 32)
# - ADMIN_TOKEN (generate secure token)
# ============================================

databases:
  # ============================================
  # PostgreSQL Database (Managed)
  # ============================================
  - name: cohe-db
    databaseName: web3_insurance
    user: postgres
    plan: free
    # Free plan: 90-day expiration, 1GB storage
    # Upgrade to Starter ($7/mo) or Pro ($20/mo) for production

services:
  # ============================================
  # API Service (NestJS Backend)
  # ============================================
  - type: web
    name: cohe-api
    runtime: docker
    plan: free
    # Free: 512MB RAM, 0.1 CPU, sleeps after 15min inactivity
    repo: https://github.com/samztz/cohe-capitl-monorepo.git  # TODO: Update this
    branch: main
    dockerfilePath: ./apps/api/Dockerfile
    dockerContext: ./

    # Custom start command to run migrations + seed before starting
    dockerCommand: sh -c "cd /app/apps/api && pnpm prisma migrate deploy && node prisma/seed.js && node dist/src/main.js"

    envVars:
      # Database (auto-linked from cohe-db)
      - key: DATABASE_URL
        fromDatabase:
          name: cohe-db
          property: connectionString

      # API configuration
      - key: NODE_ENV
        value: production
      - key: API_PORT
        value: 3001
      - key: API_PREFIX
        value: api
      - key: PORT
        value: 3001

      # JWT secrets (REQUIRED - set as secrets in Blueprint)
      - key: JWT_SECRET
        generateValue: true  # Auto-generate secure random value
      - key: JWT_EXPIRATION
        value: 15m
      - key: JWT_REFRESH_SECRET
        generateValue: true  # Auto-generate secure random value
      - key: JWT_REFRESH_EXPIRATION
        value: 7d

      # Admin token (REQUIRED - set as secret)
      - key: ADMIN_TOKEN
        generateValue: true  # Auto-generate secure random value

      # SIWE configuration
      # Note: Update after deployment with actual service URLs
      - key: SIWE_DOMAIN
        value: cohe-web.onrender.com
      - key: SIWE_URI
        value: https://cohe-web.onrender.com

      # CORS - update after getting actual service URLs
      - key: CORS_ORIGIN
        value: "*"  # Permissive for initial setup, restrict after deployment

      # File storage
      - key: SIGNATURE_STORAGE_DIR
        value: uploads/signatures

      # Blockchain
      - key: RPC_BSC
        value: https://bsc-dataseed.binance.org/
      - key: TREASURY_ADDRESS
        value: "0x8626f6940E2eb28930eFb4CeF49B2d1F2C9C1199"

      # Prisma engine path
      - key: PRISMA_QUERY_ENGINE_LIBRARY
        value: /app/apps/api/generated/prisma/libquery_engine-linux-musl-openssl-3.0.x.so.node

    # Health check
    healthCheckPath: /api/healthz

  # ============================================
  # Web Service (Next.js User Frontend)
  # ============================================
  - type: web
    name: cohe-web
    runtime: docker
    plan: free
    repo: https://github.com/samztz/cohe-capitl-monorepo.git  # TODO: Update this
    branch: main
    dockerfilePath: ./apps/web/Dockerfile
    dockerContext: ./

    # Build args for NEXT_PUBLIC_* variables (must be set at build time)
    buildFilter:
      paths:
        - apps/web/**

    envVars:
      # Runtime
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000

      # Build-time env vars (passed as Docker build args)
      - key: NEXT_PUBLIC_API_BASE
        value: /api

      # WalletConnect (REQUIRED)
      - key: NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID
        sync: false  # Must be set manually or in repo secrets

      - key: NEXT_PUBLIC_CHAIN_ID
        value: 97
      - key: NEXT_PUBLIC_CHAIN_NAME
        value: "BSC Testnet"
      - key: NEXT_PUBLIC_APP_NAME
        value: "Cohe Capital"
      - key: NEXT_PUBLIC_APP_DESCRIPTION
        value: "Web3 Insurance Platform"

    # Rewrite routes to proxy /api to API service
    routes:
      - type: rewrite
        source: /api/*
        destination: https://cohe-api.onrender.com/*
      - type: rewrite
        source: /api-docs
        destination: https://cohe-api.onrender.com/api-docs
      - type: rewrite
        source: /uploads/*
        destination: https://cohe-api.onrender.com/uploads/*

  # ============================================
  # Admin Service (Next.js Admin Panel)
  # ============================================
  - type: web
    name: cohe-admin
    runtime: docker
    plan: free
    repo: https://github.com/samztz/cohe-capitl-monorepo.git  # TODO: Update this
    branch: main
    dockerfilePath: ./apps/admin/Dockerfile
    dockerContext: ./

    buildFilter:
      paths:
        - apps/admin/**

    envVars:
      # Runtime
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3002

      # Build-time
      - key: NEXT_PUBLIC_ADMIN_API_BASE
        value: /api

    # Proxy API requests
    routes:
      - type: rewrite
        source: /api/*
        destination: https://cohe-api.onrender.com/*
      - type: rewrite
        source: /api-docs
        destination: https://cohe-api.onrender.com/api-docs
      - type: rewrite
        source: /uploads/*
        destination: https://cohe-api.onrender.com/uploads/*

# ============================================
# DEPLOYMENT GUIDE
# ============================================
#
# Step 1: Prepare Repository
# ---------------------------
# 1. Update "repo:" URLs above with your actual GitHub repository
# 2. Commit and push this render.yaml to your repository
# 3. Ensure all Dockerfiles are in the correct paths
#
# Step 2: Create Blueprint on Render
# -----------------------------------
# 1. Visit: https://dashboard.render.com/blueprints
# 2. Click "New Blueprint Instance"
# 3. Select your GitHub repository
# 4. Render will detect this render.yaml automatically
#
# Step 3: Configure Secrets
# --------------------------
# During Blueprint setup, you'll be prompted for:
# - NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID
# - JWT_SECRET (or let Render auto-generate)
# - JWT_REFRESH_SECRET (or let Render auto-generate)
# - ADMIN_TOKEN (or let Render auto-generate)
#
# Step 4: Deploy
# --------------
# Click "Apply" - Render will:
# 1. Create PostgreSQL database
# 2. Build and deploy API service
# 3. Build and deploy Web service
# 4. Build and deploy Admin service
# 5. Connect all services together
#
# Step 5: Post-Deployment Configuration
# --------------------------------------
# After first deployment, update these in Render Dashboard:
#
# In cohe-api service environment variables:
# - SIWE_DOMAIN → actual cohe-web URL (e.g., cohe-web.onrender.com)
# - SIWE_URI → https://cohe-web.onrender.com
# - CORS_ORIGIN → https://cohe-web.onrender.com,https://cohe-admin.onrender.com
#
# Then restart the API service.
#
# Step 6: Verify Deployment
# --------------------------
# Visit these URLs to confirm:
# - https://cohe-api.onrender.com/api/healthz (should return "ok")
# - https://cohe-web.onrender.com (user frontend)
# - https://cohe-admin.onrender.com (admin panel)
#
# ============================================
# ALTERNATIVE: Manual Service Creation
# ============================================
#
# If Blueprint doesn't work, create services manually:
#
# 1. Database:
#    - New → PostgreSQL
#    - Name: cohe-db, Database: web3_insurance
#    - Plan: Free (or Starter for production)
#
# 2. API Service:
#    - New → Web Service
#    - Connect GitHub repo
#    - Runtime: Docker
#    - Dockerfile path: ./apps/api/Dockerfile
#    - Docker context: ./
#    - Environment: Copy from this file's API envVars section
#    - Link database: cohe-db
#
# 3. Web Service:
#    - New → Web Service
#    - Runtime: Docker
#    - Dockerfile path: ./apps/web/Dockerfile
#    - Add rewrites for /api routes
#
# 4. Admin Service:
#    - Similar to Web service
#    - Dockerfile path: ./apps/admin/Dockerfile
#
# ============================================
# COST ESTIMATION (Free Tier)
# ============================================
#
# Services on free plan (with limitations):
# - Database: Free (90 days, then $7/mo)
# - API: Free (sleeps after 15min, 50s cold start)
# - Web: Free (sleeps after 15min)
# - Admin: Free (sleeps after 15min)
#
# Total free hours: 750/month shared across 3 web services
# = ~250 hours per service (~8 hours/day active time)
#
# For 24/7 production use, upgrade to:
# - Database Starter: $7/mo
# - API Starter: $7/mo
# - Web Starter: $7/mo
# - Admin Starter: $7/mo
# Total: ~$28/month
#
# ============================================
# TROUBLESHOOTING
# ============================================
#
# Build fails:
# - Check Docker build logs in Render Dashboard
# - Verify Dockerfile paths are correct
# - Ensure pnpm-workspace.yaml exists in root
#
# Database migration fails:
# - Check DATABASE_URL is properly connected
# - View logs: render logs cohe-api
# - Manual migration: render shell cohe-api
#   → cd /app/apps/api && pnpm prisma migrate deploy
#
# Service crashes on startup:
# - Check environment variables are set
# - Review startup logs
# - Verify health check endpoint works
#
# Cold starts too slow:
# - Upgrade from free plan to Starter ($7/mo)
# - Starter plan: no sleep, faster CPU
#
# CORS errors:
# - Update CORS_ORIGIN with exact service URLs
# - Include https:// protocol
# - No trailing slashes
# - Restart API service after changes
#
# ============================================

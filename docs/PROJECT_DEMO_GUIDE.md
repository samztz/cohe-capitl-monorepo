# 🎯 COHE.CAPITL 项目演示指南

> **适用场景**: 技术演示、项目汇报、投资者展示
> **目标受众**: 非技术背景的项目负责人、投资人、业务方
> **演示时长**: 15-20 分钟

---

## 📌 一句话介绍

**COHE.CAPITL** 是一个 **Web3 保险 DApp 平台**，用户通过 **钱包登录**，在线购买加密货币保险产品，平台提供从**选购、签约、支付到理赔**的全流程数字化服务。

**核心亮点**: 去中心化登录 + 中心化审核 + 链上支付验证 + 实时倒计时状态

---

## 🎨 项目背景：一个人的全栈之旅

### 我承担的四个角色

在这个项目中，我一个人完成了通常需要**四个人**才能完成的工作：

| 角色 | 我做了什么 | 通常需要的技能 |
|------|-----------|--------------|
| 🎨 **设计师** | UI/UX 设计、页面布局、交互流程、视觉风格 | Figma, 设计思维 |
| 📋 **产品经理** | 需求分析、功能规划、业务流程设计、数据模型设计 | 业务理解、用户研究 |
| 💻 **开发工程师** | 前端 Web、管理后台、后端 API、数据库、区块链集成 | 全栈开发能力 |
| 🚀 **运维工程师** | 数据库部署、环境配置、监控、文档维护 | DevOps、云服务 |

### 开发历程

- **总时长**: 约 30 天（2024年10月17日 - 2025年11月16日）
- **代码量**:
  - 前端 (Next.js Web): ~8,000 行
  - 管理后台 (Next.js Admin): ~3,500 行
  - 后端 API (NestJS): ~6,000 行
  - 总计: **约 17,500 行** TypeScript 代码
- **完成度**: 70.3% (37个任务中完成26个)

---

## 🏗️ 系统架构：三个核心应用

```
┌─────────────────────────────────────────────────────────────┐
│                     用户 (钱包持有者)                        │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────┐
        │   🌐 Web DApp (用户端)              │
        │   - 钱包连接 (Reown AppKit)         │
        │   - SIWE 登录 (签名验证)            │
        │   - 产品浏览与购买                   │
        │   - 合同签署 (数字签名)             │
        │   - USDT 支付                       │
        │   - 保单管理与倒计时                 │
        └─────────────────────────────────────┘
                              │
                              │ REST API
                              ▼
        ┌─────────────────────────────────────┐
        │   ⚙️ Backend API (NestJS)          │
        │   - 用户认证 (JWT)                  │
        │   - 保单业务逻辑                     │
        │   - 支付验证 (BSC链上)              │
        │   - 数据持久化 (PostgreSQL)         │
        └─────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
   ┌────────────────────┐      ┌─────────────────────┐
   │  🖥️ Admin 管理后台  │      │  🔗 BSC 区块链       │
   │  - 保单审核          │      │  - 钱包签名验证      │
   │  - 状态管理          │      │  - USDT 转账记录     │
   │  - 数据统计          │      │  - 链上事件监听      │
   └────────────────────┘      └─────────────────────┘
```

### 三个应用的分工

1. **Web DApp (用户端)**
   - **技术**: Next.js 14 + Reown AppKit + Ethers.js
   - **用途**: 普通用户购买保险的入口
   - **核心页面**: 产品列表、保单申请、合同签署、支付、保单详情

2. **Backend API (核心引擎)**
   - **技术**: NestJS + Prisma + PostgreSQL
   - **用途**: 处理所有业务逻辑和数据存储
   - **核心功能**: 用户认证、保单 CRUD、支付验证、状态管理

3. **Admin 管理后台**
   - **技术**: Next.js 14 + shadcn/ui
   - **用途**: 管理员审核保单、监控系统
   - **核心页面**: 待审核列表、保单详情、数据统计

---

## 💡 技术亮点：为什么值得关注

### 1️⃣ 钱包登录 - 无需注册的 Web3 体验

**传统方式的痛点**:
- 需要注册账号、记住密码
- 需要邮箱验证、手机验证
- 容易被钓鱼、密码泄露

**我们的解决方案**:
```typescript
// 用户只需连接钱包，用私钥签名一条消息即可登录
const message = `登录 COHE.CAPITL
地址: ${walletAddress}
时间: ${timestamp}
随机数: ${nonce}`;

const signature = await wallet.signMessage(message);
// ✅ 后端验证签名 → 签发 JWT token → 用户登录成功
```

**优势**:
- ✅ **零注册**: 有钱包就能用
- ✅ **安全**: 私钥从不离开用户设备
- ✅ **便捷**: 一键连接，30秒完成登录

**技术实现**: SIWE (Sign-In with Ethereum) EIP-4361 标准

---

### 2️⃣ 数字合同签署 - 防篡改的电子协议

**业务场景**:
用户在购买保险时需要签署保险合同。传统方式是打印、手写签名、扫描上传，效率低且容易造假。

**我们的创新**:
```typescript
// 1. 生成合同哈希（包含所有关键信息）
const contractData = {
  policyId: "policy-123",
  walletAddress: "0xABC...",
  coverageAmount: "10000 USDT",
  premiumAmount: "100 USDT",
  termDays: 90,
  timestamp: 1699999999
};

// 2. 用户用钱包私钥签署合同哈希
const contractHash = sha256(JSON.stringify(contractData));
const userSignature = await wallet.signMessage(contractHash);

// 3. 保存签名 → 任何人都能验证合同真实性且未被篡改
```

**优势**:
- ✅ **防篡改**: 合同内容任何修改都会导致哈希变化
- ✅ **可验证**: 任何第三方都能验证签名真实性
- ✅ **无纸化**: 全流程数字化
- ✅ **法律效力**: 符合《电子签名法》要求

---

### 3️⃣ 链上支付验证 - 自动化的资金追踪

**传统方式的问题**:
- 银行转账需要人工确认到账
- 容易被伪造转账截图欺骗
- 对账工作量大

**我们的方案**:
```typescript
// 用户支付 100 USDT 后，后端自动监听 BSC 链
const payment = await bscRpc.getTransaction(txHash);

// 验证四要素
✅ 发送地址: payment.from === policy.walletAddress
✅ 接收地址: payment.to === TREASURY_ADDRESS
✅ 金额: payment.value === policy.premiumAmt
✅ 代币: payment.token === "USDT (BEP-20)"

// 全部验证通过 → 自动激活保单
if (verified) {
  policy.status = "ACTIVE";
  policy.startAt = now;
  policy.endAt = now + 90 days;
}
```

**优势**:
- ✅ **实时**: 链上确认后几分钟内自动激活
- ✅ **防伪**: 链上数据不可篡改
- ✅ **透明**: 所有交易公开可查
- ✅ **降本**: 无需人工对账

---

### 4️⃣ 国际化支持 - 一键切换中英文

**实现效果**:
- 中文: "保单详情"
- English: "Policy Details"
- 繁体中文: "保單詳情"

**技术实现**:
```typescript
// 所有文案都从语言包读取
const t = useTranslations();  // 自动根据用户设置选择语言

<h1>{t.policyDetail.title}</h1>
// 中文显示: "保单详情"
// English: "Policy Details"
```

**工作量**:
- ✅ 替换了 **800+ 处硬编码文案**
- ✅ 支持 **英文 (en) 和繁体中文 (zh-TW)**
- ✅ **动态参数替换**: "剩余 {days} 天" → "剩余 30 天"

---

### 5️⃣ 多链支持 - 动态网络切换

**业务需求**:
不同保险产品可能部署在不同的区块链上（BSC、Polygon、Arbitrum 等）

**技术难点**:
之前代码把网络 ID 写死了，导致所有保单只能在一条链上操作。

**我的优化**:
```typescript
// 修改前 (硬编码)
const CHAIN_ID = 97;  // 写死 BSC Testnet
if (currentChain !== 97) {
  throw new Error("请切换到 BSC Testnet");
}

// 修改后 (动态读取)
const expectedChain = product.chainId;  // 从产品信息读取
if (currentChain !== expectedChain) {
  throw new Error(`请切换到 ${getChainName(expectedChain)}`);
}
```

**优势**:
- ✅ 同一个平台可以销售多条链的产品
- ✅ 用户体验更好（错误提示更精准）
- ✅ 扩展性强（未来可轻松支持新链）

---

## 🚧 技术难点与取舍

### 难点 1: 状态机设计 - 保单的生命周期管理

**挑战**: 一个保单从创建到结束有很多状态，如何确保状态流转正确？

```
草稿 → 待审核 → 待支付 → 已激活 → 已过期
  ↓                ↓
 (删除)          (被拒绝)
```

**我的解决方案**:
- 使用 TypeScript 枚举严格定义状态
- 后端校验状态转换规则（例如：已激活的保单不能退回待审核）
- 前端根据状态动态显示操作按钮

**取舍**:
- ✅ **选择**: 在后端严格校验状态转换
- ❌ **放弃**: 前端复杂的状态机逻辑（降低维护成本）

---

### 难点 2: 支付确认 - 如何防止重复激活

**挑战**: 同一笔链上转账可能被多次提交确认，如何防止重复？

**我的方案**:
```typescript
// 1. 数据库约束：txHash 设为唯一索引
@@unique([txHash])

// 2. 业务逻辑：检查 txHash 是否已被使用
const existing = await db.payment.findUnique({ where: { txHash } });
if (existing) {
  throw new Error("该交易已被确认，请勿重复提交");
}

// 3. 状态检查：只有待支付状态才能激活
if (policy.status !== "APPROVED_AWAITING_PAYMENT") {
  throw new Error("保单状态错误");
}
```

**取舍**:
- ✅ **选择**: 三重保护（数据库 + 业务逻辑 + 状态检查）
- ❌ **放弃**: 分布式锁（暂时不需要高并发场景）

---

### 难点 3: 移动端还是 Web？

**早期决策**: 最开始计划做 React Native 移动 App

**遇到的问题**:
- 移动端钱包集成复杂（WalletConnect v2 兼容性问题）
- 需要发布到 App Store / Google Play（审核周期长）
- 用户下载门槛高

**最终决策**: **全面转向 Web DApp**

**理由**:
- ✅ 用户直接通过浏览器访问，无需下载
- ✅ Web 端钱包集成更成熟（Reown AppKit）
- ✅ 开发效率更高（Next.js 生态完善）
- ✅ 更新部署快（无需等待应用商店审核）

**取舍**:
- ✅ **保留**: Mobile 代码作为参考（`apps/mobile/`目录）
- ❌ **放弃**: 继续维护移动端（集中资源在 Web 端）

---

## 📊 数据与成果

### 代码统计

| 模块 | 代码行数 | 文件数 | 主要语言 |
|------|---------|-------|---------|
| Web DApp (前端) | ~8,000 | 45 | TypeScript + TSX |
| Admin 后台 | ~3,500 | 28 | TypeScript + TSX |
| Backend API | ~6,000 | 52 | TypeScript |
| 数据库 Schema | ~300 | 1 | Prisma |
| **总计** | **~17,800** | **126** | TypeScript |

### 功能完成度

| Epic (功能模块) | 完成度 | 说明 |
|----------------|--------|------|
| 后端基础与认证 | ✅ 100% | SIWE 登录 + JWT 鉴权 |
| 保单购买闭环 | ✅ 100% | 从创建到激活的完整流程 |
| Admin 管理后台 | ✅ 100% | 审核、统计、配置管理 |
| Web DApp 前端 | 🟡 83% | 5/6 页面完成（剩余保单详情页） |
| 前后端联调测试 | ⚪ 0% | 待进行 |
| 部署与演示环境 | ⚪ 0% | 待进行 |
| **整体进度** | **70.3%** | 26/37 任务完成 |

### API 接口数量

- **用户端 API**: 12 个端点
- **Admin API**: 8 个端点
- **公共 API**: 3 个端点
- **总计**: **23 个 REST API**

---

## 🎬 演示流程建议

### 准备工作 (演示前 5 分钟)

```bash
# 1. 启动 PostgreSQL 数据库
docker compose -f infra/docker/docker-compose.yml up -d db

# 2. 启动后端 API
pnpm --filter api dev
# 等待提示: Server is running on http://localhost:3001

# 3. 启动 Web 前端
pnpm --filter web dev
# 等待提示: Local: http://localhost:3030

# 4. 启动 Admin 后台
pnpm --filter admin dev
# 等待提示: Local: http://localhost:3031

# 5. 打开 Prisma Studio (数据库可视化)
pnpm --filter api prisma:studio
# 打开 http://localhost:5555
```

### 演示步骤 (15 分钟)

#### 第一部分: 用户购买保险 (7 分钟)

1. **展示首页** (30秒)
   - 打开 `http://localhost:3030`
   - 展示品牌 Logo 和产品定位

2. **钱包登录** (1分钟)
   - 点击"Connect Wallet"
   - 选择 MetaMask
   - 签名 SIWE 消息
   - 展示登录成功后的 Dashboard

3. **浏览产品** (1分钟)
   - 进入 Products 页面
   - 展示产品卡片（保障金额、保费、期限）
   - 点击"立即投保"

4. **填写保单** (2分钟)
   - 自动填充钱包地址
   - 输入保障金额
   - 实时计算保费
   - 展示表单验证

5. **签署合同** (2分钟)
   - 查看合同内容
   - 勾选"已阅读并同意"
   - 钱包签名
   - 展示签名成功提示

6. **支付保费** (30秒)
   - 展示支付信息（网络、代币、金额、地址）
   - 说明实际支付流程（因演示跳过真实转账）
   - 输入模拟的交易哈希

#### 第二部分: 管理员审核 (5 分钟)

7. **Admin 登录** (30秒)
   - 打开 `http://localhost:3031`
   - 使用 demo token 登录

8. **查看待审核列表** (1分钟)
   - 展示刚才创建的保单
   - 查看保单详情（申请人地址、金额、合同签名）

9. **审核通过** (1分钟)
   - 点击"Approve"
   - 填写审核备注
   - 提交审核

10. **数据统计** (1分钟)
    - 展示 Dashboard 统计数据
    - 今日审核数、通过率等

11. **数据库验证** (1.5分钟)
    - 打开 Prisma Studio (`http://localhost:5555`)
    - 查看 Policy 表中的状态变化
    - 查看 User 表、Payment 表

#### 第三部分: 技术亮点总结 (3 分钟)

12. **展示代码** (1.5分钟)
    - 打开 VS Code
    - 展示 SIWE 登录逻辑 (`apps/web/src/hooks/useSiweAuth.ts`)
    - 展示合同签名逻辑 (`apps/web/src/app/policy/contract-sign/[policyId]/page.tsx`)
    - 展示后端 API (`apps/api/src/modules/policy/policy.controller.ts`)

13. **技术栈总结** (1分钟)
    - Next.js 14 (前端)
    - NestJS (后端)
    - Prisma + PostgreSQL (数据库)
    - Ethers.js (区块链)
    - Reown AppKit (钱包)

14. **未来规划** (30秒)
    - 完善支付验证
    - 增加理赔流程
    - 部署上线

---

## 🎓 给非技术人员的解释

### 什么是 SIWE (钱包登录)？

**类比**: 就像用微信扫码登录网站，但更安全。

- 传统方式: 输入账号密码 → 容易泄露
- SIWE 方式: 用钱包签名一条消息 → 私钥从不暴露

### 什么是智能合约？

**类比**: 自动售货机

- 传统合同: 双方签字 → 依赖法律强制执行 → 有争议时需要打官司
- 智能合约: 代码自动执行 → 满足条件自动触发 → 无需信任第三方

**例子**:
```
如果 (用户支付了 100 USDT) {
  自动激活保单;
  设置到期时间 = 今天 + 90天;
}
```

### 什么是链上验证？

**类比**: 银行流水 vs 区块链流水

| 对比项 | 银行流水 | 区块链流水 |
|--------|---------|-----------|
| 是否公开 | ❌ 私密（只有持卡人能查） | ✅ 公开（任何人可查） |
| 能否篡改 | ⚠️ 银行可能修改 | ✅ 不可篡改 |
| 确认时间 | 🕐 T+1 到账 | ⚡ 几分钟 |
| 手续费 | 💰 银行收费 | 💸 Gas 费 |

### 什么是 TypeScript？

**类比**: JavaScript 是散文，TypeScript 是合同

- JavaScript: "给我一个数字" → 你可能给我文字，运行时才报错
- TypeScript: "给我一个数字类型" → 编译时就检查，写错了立即提示

---

## 🌟 项目价值

### 商业价值

1. **降低信任成本**
   - 传统保险: 需要信任保险公司
   - Web3 保险: 代码即规则，透明可验证

2. **提升效率**
   - 传统: 填表 → 审核 → 签约 → 邮寄 → 支付 → 激活 (7-14天)
   - 我们: 填表 → 签名 → 支付 → 审核 → 激活 (1-2天)

3. **覆盖新市场**
   - 服务加密货币持有者（传统保险难以服务的人群）
   - 跨境业务无需复杂的合规流程

### 技术价值

1. **全栈架构实践**
   - 展示了完整的现代 Web 应用开发流程
   - 前后端分离、API 设计、数据库建模

2. **区块链集成经验**
   - 钱包连接、签名验证、交易监听
   - 可复用到其他 Web3 项目

3. **工程化能力**
   - Monorepo 管理（pnpm workspace）
   - TypeScript 严格模式
   - 代码规范与文档

---

## 📚 参考资料

### 核心文档

- [项目总览](../README.md)
- [开发进度](./project_state.md)
- [更新日志](./CHANGELOG.md)
- [协作规范](../CLAUDE.md)

### 技术文档

- [Backend API 文档](../apps/api/README.md)
- [Web DApp 文档](../apps/web/README.md)
- [Admin 后台文档](../apps/admin/README.md)

### 在线资源

- **SIWE 标准**: https://docs.login.xyz/
- **Reown AppKit**: https://docs.reown.com/appkit/overview
- **Next.js 文档**: https://nextjs.org/docs
- **NestJS 文档**: https://docs.nestjs.com/
- **Prisma 文档**: https://www.prisma.io/docs

---

## ❓ 常见问题

### Q1: 为什么不用以太坊主网？

**A**: 成本考虑。以太坊主网 Gas 费太高（一次交易可能 10-50 美元），BSC 只需要几美分。等项目成熟后可以支持多链。

### Q2: 数据存在链上还是数据库？

**A**: 混合方式
- **链上**: 支付记录、合同签名哈希（不可篡改的关键数据）
- **数据库**: 用户信息、保单详情、审核记录（便于查询和管理）

### Q3: 如果钱包丢了怎么办？

**A**: 这是 Web3 的核心问题。当前方案:
- 用户自己保管私钥
- 可以考虑增加邮箱绑定作为辅助验证
- 企业级用户可以用多签钱包

### Q4: 一个人开发有什么好处和坏处？

**A**:
- ✅ **好处**: 决策快、沟通成本低、技术栈统一、学习全面
- ❌ **坏处**: 工作量大、知识面要求广、单点故障风险

### Q5: 项目还缺什么？

**A**:
- 前后端联调测试（API 接口稳定性验证）
- 部署环境（Docker + CI/CD）
- 性能优化（缓存、CDN）
- 安全审计（合约审计、渗透测试）

---

## 🎯 演示 Tips

### 给技术人员讲

- 重点讲**架构设计**（前后端分离、API 设计、状态机）
- 展示**代码质量**（TypeScript、测试、文档）
- 讨论**技术选型**（为什么用 NestJS 而不是 Express）

### 给非技术人员讲

- 重点讲**业务流程**（用户怎么买保险、管理员怎么审核）
- 用**类比**解释技术（钱包 = 微信、区块链 = 公开账本）
- 展示**界面操作**（少讲代码，多演示功能）

### 给投资人讲

- 重点讲**商业价值**（市场机会、成本优势、可扩展性）
- 展示**完成度**（70% 完成、主流程跑通）
- 说明**下一步计划**（联调 → 测试 → 上线）

---

**祝演示成功！** 🎉

如有疑问，请联系项目开发者 Samztz。

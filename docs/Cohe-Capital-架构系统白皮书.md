# ğŸ“˜ Cohe Capital æ¶æ„ç³»ç»Ÿç™½çš®ä¹¦

**ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-11-20
**æ–‡æ¡£çŠ¶æ€**: æ­£å¼ç‰ˆï¼ˆåŸºäºå®é™…ä»£ç åº“ç”Ÿæˆï¼‰
**é€‚ç”¨é˜¶æ®µ**: MVP ç¨³å®šåŒ– â†’ Demo å‘å¸ƒ â†’ ç”Ÿäº§éƒ¨ç½²
**ä½œè€…**: Cohe Capital æŠ€æœ¯æ¶æ„ç»„

---

## ğŸ“‘ ç›®å½•

1. [ç®€ä»‹](#1-ç®€ä»‹)
2. [ç³»ç»Ÿç›®æ ‡](#2-ç³»ç»Ÿç›®æ ‡)
3. [äº§å“è§’è‰²ä¸ä¸šåŠ¡æµç¨‹](#3-äº§å“è§’è‰²ä¸ä¸šåŠ¡æµç¨‹)
4. [æ•´ä½“æŠ€æœ¯æ¶æ„](#4-æ•´ä½“æŠ€æœ¯æ¶æ„)
5. [æŠ€æœ¯æ ˆè¯¦è§£](#5-æŠ€æœ¯æ ˆè¯¦è§£)
6. [æ ¸å¿ƒåŠŸèƒ½æ¨¡å—](#6-æ ¸å¿ƒåŠŸèƒ½æ¨¡å—)
7. [æ•°æ®æ¨¡å‹](#7-æ•°æ®æ¨¡å‹)
8. [ä¸šåŠ¡æµç¨‹è¯¦è§£](#8-ä¸šåŠ¡æµç¨‹è¯¦è§£)
9. [æ‰‹å†™ç­¾åç³»ç»Ÿ](#9-æ‰‹å†™ç­¾åç³»ç»Ÿ)
10. [åŒºå—é“¾é›†æˆ](#10-åŒºå—é“¾é›†æˆ)
11. [å®‰å…¨è®¾è®¡](#11-å®‰å…¨è®¾è®¡)
12. [éƒ¨ç½²æ¶æ„](#12-éƒ¨ç½²æ¶æ„)
13. [å›½é™…åŒ–ä¸æœ¬åœ°åŒ–](#13-å›½é™…åŒ–ä¸æœ¬åœ°åŒ–)
14. [ç›‘æ§ä¸æ—¥å¿—](#14-ç›‘æ§ä¸æ—¥å¿—)
15. [æµ‹è¯•ç­–ç•¥](#15-æµ‹è¯•ç­–ç•¥)
16. [è·¯å¾„è§„åˆ’](#16-è·¯å¾„è§„åˆ’)
17. [é™„å½•](#17-é™„å½•)

---

## 1. ç®€ä»‹

### 1.1 é¡¹ç›®æ¦‚è¿°

Cohe Capital æ˜¯ä¸€ä¸ªåŸºäºåŒºå—é“¾çš„**å»ä¸­å¿ƒåŒ–ä¿é™©å¹³å°**ï¼Œä¸º Web3 ç”¨æˆ·æä¾›é€æ˜ã€å®‰å…¨ã€é«˜æ•ˆçš„ä¿é™©æœåŠ¡ã€‚å¹³å°é‡‡ç”¨ç°ä»£åŒ–çš„æŠ€æœ¯æ ˆï¼Œå®ç°äº†ä»ç”¨æˆ·æ³¨å†Œã€äº§å“é€‰è´­ã€åˆåŒç­¾ç½²åˆ°é“¾ä¸Šæ”¯ä»˜çš„å®Œæ•´ä¸šåŠ¡é—­ç¯ã€‚

### 1.2 æ ¸å¿ƒç‰¹æ€§

- âœ… **Web3 åŸç”Ÿç™»å½•**: åŸºäº SIWE (EIP-4361) çš„å»ä¸­å¿ƒåŒ–èº«ä»½è®¤è¯
- âœ… **é“¾ä¸Šæ”¯ä»˜**: BSC åŒºå—é“¾æ”¯ä»˜ï¼Œæ”¯æŒ USDT/USDC/BNB ç­‰ä»£å¸
- âœ… **ç”µå­ç­¾å**: æ‰‹å†™ç­¾å + åŠ å¯†ç­¾ååŒé‡ä¿éšœ
- âœ… **å¤šè§’è‰²ç³»ç»Ÿ**: ç”¨æˆ·ç«¯ã€ç®¡ç†å‘˜å®¡æ ¸ç³»ç»Ÿå®Œæ•´åˆ†ç¦»
- âœ… **å®¹å™¨åŒ–éƒ¨ç½²**: Docker + Nginx ç”Ÿäº§çº§éƒ¨ç½²æ–¹æ¡ˆ
- âœ… **å›½é™…åŒ–æ”¯æŒ**: è‹±æ–‡ / ç¹ä½“ä¸­æ–‡åŒè¯­

### 1.3 é¡¹ç›®æ¶æ„

æœ¬é¡¹ç›®é‡‡ç”¨ **Monorepo** æ¶æ„ï¼Œä½¿ç”¨ pnpm workspace + Turbo è¿›è¡Œæ„å»ºç¼–æ’ï¼š

```
cohe-capitl-monorepo/
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ web/          # Next.js 14 ç”¨æˆ·ç«¯ Web DApp
â”‚   â”œâ”€â”€ admin/        # Next.js 14 ç®¡ç†åå°
â”‚   â””â”€â”€ api/          # NestJS åç«¯ API
â”œâ”€â”€ packages/         # å…±äº«åŒ… (é¢„ç•™)
â”œâ”€â”€ infra/            # åŸºç¡€è®¾æ–½é…ç½® (Docker, Nginx)
â””â”€â”€ docs/             # é¡¹ç›®æ–‡æ¡£
```

---

## 2. ç³»ç»Ÿç›®æ ‡

### 2.1 ä¸šåŠ¡ç›®æ ‡

æ„å»ºä¸€ä¸ª**å®‰å…¨ã€é€æ˜ã€é«˜æ•ˆ**çš„ Web3 ä¿é™©å¹³å°ï¼Œæ”¯æŒä»¥ä¸‹å®Œæ•´ä¸šåŠ¡é—­ç¯ï¼š

```
äº§å“æµè§ˆ â†’ ä¿å•åˆ›å»º â†’ åˆåŒç­¾ç½² â†’ é£æ§å®¡æ ¸ â†’ é“¾ä¸Šæ”¯ä»˜ â†’ ä¿å•æ¿€æ´» â†’ ç”Ÿå‘½å‘¨æœŸç®¡ç†
```

### 2.2 æŠ€æœ¯ç›®æ ‡

| ç›®æ ‡ç±»åˆ« | å…·ä½“è¦æ±‚ |
|---------|---------|
| **å®‰å…¨æ€§** | SIWE å»ä¸­å¿ƒåŒ–ç™»å½•ã€JWT è®¤è¯ã€ç­¾åéªŒè¯ã€å®¡è®¡æ—¥å¿— |
| **å¯æ‰©å±•æ€§** | æ¨¡å—åŒ–æ¶æ„ã€å®¹å™¨åŒ–éƒ¨ç½²ã€æ”¯æŒæ°´å¹³æ‰©å±• |
| **å¯ç»´æŠ¤æ€§** | ç±»å‹å®‰å…¨ (TypeScript)ã€ç»Ÿä¸€ Schema (Prisma)ã€æ¸…æ™°æ¨¡å—èŒè´£ |
| **é«˜å¯ç”¨æ€§** | å¥åº·æ£€æŸ¥ã€è‡ªåŠ¨é‡å¯ã€è´Ÿè½½å‡è¡¡ (Nginx) |
| **æ€§èƒ½** | SSR + CSR æ··åˆæ¸²æŸ“ã€API å“åº”æ—¶é—´ < 200msã€æ•°æ®åº“è¿æ¥æ±  |

### 2.3 é¡¹ç›®è¿›åº¦

**æ€»ä½“å®Œæˆåº¦**: 71.6% (æˆªè‡³ 2025-11-20)

| Epic | å®Œæˆç‡ | çŠ¶æ€ |
|------|--------|------|
| E1: åç«¯åŸºç¡€ä¸è®¤è¯ | 100% (4/4) | âœ… å®Œæˆ |
| E2: ä¿å•è´­ä¹°é—­ç¯ | 100% (11/11) | âœ… å®Œæˆ |
| E4: Web DApp | 83.3% (5/6) | ğŸŸ¡ è¿›è¡Œä¸­ |
| E7: Admin å®¡æ ¸å‰ç«¯ | 100% (8/8) | âœ… å®Œæˆ |
| E6: éƒ¨ç½²ä¸æ¼”ç¤ºç¯å¢ƒ | 25% (1/4) | ğŸŸ¡ è¿›è¡Œä¸­ |

---

## 3. äº§å“è§’è‰²ä¸ä¸šåŠ¡æµç¨‹

### 3.1 è§’è‰²å®šä¹‰

| è§’è‰² | æƒé™ä¸èŒè´£ | è®¤è¯æ–¹å¼ |
|------|-----------|---------|
| **ç”¨æˆ· (User)** | è¿æ¥é’±åŒ…ã€æµè§ˆäº§å“ã€è´­ä¹°ä¿é™©ã€ç­¾ç½²åˆåŒã€æŸ¥çœ‹ä¿å• | SIWE + JWT |
| **ç®¡ç†å‘˜ (Admin)** | å®¡æ ¸ä¿å• (æ‰¹å‡†/æ‹’ç»)ã€æŸ¥çœ‹ç­¾åå…ƒæ•°æ®ã€ç®¡ç†ç³»ç»Ÿé…ç½® | Bearer Token |
| **ç³»ç»Ÿ (System)** | ç”Ÿæˆ nonceã€éªŒè¯ç­¾åã€è®°å½•äº¤æ˜“ã€çŠ¶æ€æœºç®¡ç† | å†…éƒ¨æœåŠ¡ |

### 3.2 ä¸šåŠ¡æµç¨‹å›¾

```mermaid
flowchart TD
    Start([ç”¨æˆ·è®¿é—®å¹³å°]) --> Connect[SIWE é’±åŒ…ç™»å½•]
    Connect --> Browse[æµè§ˆäº§å“åˆ—è¡¨]
    Browse --> Select[é€‰æ‹©äº§å“ SKU]
    Select --> Form[å¡«å†™ä¿å•è¡¨å•]
    Form --> Sign[ç­¾ç½²åˆåŒ<br/>æ‰‹å†™ç­¾å + é’±åŒ…ç­¾å]
    Sign --> Submit[æäº¤å®¡æ ¸]

    Submit --> Review{ç®¡ç†å‘˜å®¡æ ¸}
    Review -->|æ‹’ç»| Rejected[ä¿å•è¢«æ‹’ç»]
    Review -->|æ‰¹å‡†| Approved[ç­‰å¾…æ”¯ä»˜<br/>24å°æ—¶æœ‰æ•ˆæœŸ]

    Approved --> Pay[é“¾ä¸Šæ”¯ä»˜<br/>è½¬è´¦åˆ° Treasury]
    Pay --> Verify[åç«¯éªŒè¯äº¤æ˜“]
    Verify --> Active[ä¿å•æ¿€æ´»]

    Approved -.->|è¶…æ—¶æœªæ”¯ä»˜| Expired[ä¿å•è¿‡æœŸ]

    Active --> Monitor[ä¿å•ç”Ÿå‘½å‘¨æœŸç®¡ç†]

    style Connect fill:#e1f5ff
    style Sign fill:#fff4e1
    style Review fill:#ffe1e1
    style Pay fill:#e1ffe1
    style Active fill:#d4edda
```

---

## 4. æ•´ä½“æŠ€æœ¯æ¶æ„

### 4.1 ç³»ç»Ÿæ¶æ„å›¾

```mermaid
graph TB
    subgraph "å®¢æˆ·ç«¯å±‚"
        User[ç”¨æˆ·æµè§ˆå™¨]
        Admin[ç®¡ç†å‘˜æµè§ˆå™¨]
    end

    subgraph "æ¥å…¥å±‚ (Docker Network)"
        Nginx[Nginx åå‘ä»£ç†<br/>:80 / :443]
    end

    subgraph "åº”ç”¨å±‚"
        Web[Web App<br/>Next.js 14<br/>:3000]
        AdminApp[Admin Panel<br/>Next.js 14<br/>:3002]
        API[API Server<br/>NestJS 11<br/>:3001]
    end

    subgraph "æ•°æ®å±‚"
        DB[(PostgreSQL 16<br/>:5432)]
        Files[/æ–‡ä»¶å­˜å‚¨<br/>uploads/signatures/]
    end

    subgraph "åŒºå—é“¾å±‚"
        BSC[BSC Mainnet/Testnet<br/>RPC Provider]
    end

    User -->|HTTP/HTTPS| Nginx
    Admin -->|HTTP/HTTPS| Nginx

    Nginx -->|/ â†’ :3000| Web
    Nginx -->|/admin â†’ :3002| AdminApp
    Nginx -->|/api â†’ :3001| API
    Nginx -->|/uploads â†’ :3001| API

    Web -->|REST API| API
    AdminApp -->|REST API| API

    API -->|Prisma ORM| DB
    API -->|æœ¬åœ°å­˜å‚¨| Files
    API -->|ethers.js| BSC
    Web -->|Reown AppKit| BSC

    style Nginx fill:#f9f,stroke:#333,stroke-width:3px
    style API fill:#bbf,stroke:#333,stroke-width:2px
    style DB fill:#bfb,stroke:#333,stroke-width:2px
    style BSC fill:#fbb,stroke:#333,stroke-width:2px
```

### 4.2 æŠ€æœ¯é€‰å‹ç†ç”±

| æŠ€æœ¯ç»„ä»¶ | é€‰å‹ç†ç”± |
|---------|---------|
| **Next.js 14** | Server Componentsã€App Routerã€SSR/SSG æ··åˆæ¸²æŸ“ã€ä¼˜ç§€çš„ SEO |
| **NestJS 11** | æ¨¡å—åŒ–æ¶æ„ã€ä¾èµ–æ³¨å…¥ã€è£…é¥°å™¨ã€æˆç†Ÿçš„ä¼ä¸šçº§æ¡†æ¶ |
| **Fastify** | æ¯” Express å¿« 2-3 å€ã€ä½å¼€é”€ã€ä¸ NestJS æ·±åº¦é›†æˆ |
| **Prisma 6** | ç±»å‹å®‰å…¨ã€è‡ªåŠ¨ç”Ÿæˆ Clientã€Schema-firstã€ä¼˜ç§€çš„è¿ç§»å·¥å…· |
| **PostgreSQL 16** | ACID ä¿è¯ã€JSON æ”¯æŒã€å¼ºå¤§çš„ç´¢å¼•ã€æˆç†Ÿç¨³å®š |
| **Docker Compose** | æœ¬åœ°å¼€å‘ä¸€è‡´æ€§ã€å¿«é€Ÿéƒ¨ç½²ã€æ˜“äºè°ƒè¯• |
| **Reown AppKit** | WalletConnect v2ã€æ”¯æŒå¤šé’±åŒ…ã€UI ç»„ä»¶å®Œæ•´ |

---

## 5. æŠ€æœ¯æ ˆè¯¦è§£

### 5.1 å‰ç«¯ Web DApp (apps/web/)

#### æ ¸å¿ƒä¾èµ–

```json
{
  "framework": {
    "next": "14.2.0",
    "react": "18.3.1",
    "react-dom": "18.3.1"
  },
  "web3": {
    "@reown/appkit": "1.8.14",
    "@reown/appkit-adapter-ethers": "1.8.14",
    "ethers": "6.13.0",
    "viem": "2.38.5"
  },
  "state": {
    "zustand": "5.0.8",
    "@tanstack/react-query": "5.62.11"
  },
  "form": {
    "react-hook-form": "7.54.0",
    "zod": "3.23.8",
    "@hookform/resolvers": "3.9.1"
  },
  "ui": {
    "tailwindcss": "3.4.17",
    "signature_pad": "5.1.2"
  },
  "utils": {
    "axios": "1.7.7",
    "dayjs": "1.11.13"
  }
}
```

#### é¡µé¢è·¯ç”±ç»“æ„

| è·¯ç”± | åŠŸèƒ½ | è®¤è¯è¦æ±‚ |
|------|------|---------|
| `/` | é¦–é¡µ (é‡å®šå‘) | å¦ |
| `/auth/connect` | SIWE ç™»å½• | å¦ |
| `/dashboard` | ä»ªè¡¨æ¿ | âœ… JWT |
| `/products` | äº§å“åˆ—è¡¨ | âœ… JWT |
| `/policy/form/[productId]` | ä¿å•è¡¨å• | âœ… JWT |
| `/policy/contract-sign/[policyId]` | åˆåŒç­¾ç½² | âœ… JWT |
| `/policy/payment/[policyId]` | æ”¯ä»˜é¡µé¢ | âœ… JWT |
| `/policy/success/[policyId]` | è´­ä¹°æˆåŠŸ | âœ… JWT |
| `/my-policies` | æˆ‘çš„ä¿å• | âœ… JWT |
| `/settings` | è®¾ç½® | âœ… JWT |

### 5.2 ç®¡ç†åå° (apps/admin/)

#### æ ¸å¿ƒä¾èµ–

```json
{
  "framework": {
    "next": "14.2.0",
    "react": "18.3.0"
  },
  "ui": {
    "@radix-ui/react-dialog": "1.0.5",
    "@radix-ui/react-dropdown-menu": "2.0.6",
    "@radix-ui/react-select": "2.0.0",
    "@radix-ui/react-tabs": "1.0.4",
    "@radix-ui/react-toast": "1.1.5",
    "lucide-react": "0.344.0"
  },
  "table": {
    "@tanstack/react-table": "8.13.0"
  },
  "state": {
    "zustand": "5.0.8",
    "@tanstack/react-query": "5.28.0"
  }
}
```

#### ä¸»è¦åŠŸèƒ½

- ä¿å•åˆ—è¡¨ (åˆ†é¡µã€ç­›é€‰ã€æœç´¢)
- ä¿å•è¯¦æƒ…æŸ¥çœ‹ (åŒ…å«æ‰‹å†™ç­¾åå›¾ç‰‡)
- å®¡æ ¸æ“ä½œ (æ‰¹å‡† / æ‹’ç» + å¤‡æ³¨)
- æ”¯ä»˜å€’è®¡æ—¶æ˜¾ç¤º
- å“åº”å¼è®¾è®¡ (shadcn/ui)

### 5.3 åç«¯ API (apps/api/)

#### æ ¸å¿ƒä¾èµ–

```json
{
  "framework": {
    "@nestjs/core": "11.1.7",
    "@nestjs/common": "11.1.7",
    "@nestjs/platform-fastify": "11.1.7",
    "fastify": "5.6.1"
  },
  "database": {
    "@prisma/client": "6.18.0",
    "prisma": "6.18.0"
  },
  "auth": {
    "@nestjs/jwt": "11.0.1",
    "@nestjs/passport": "11.0.5",
    "passport-jwt": "4.0.1",
    "siwe": "3.0.0",
    "bcryptjs": "3.0.2"
  },
  "web3": {
    "ethers": "6.x"
  },
  "validation": {
    "class-validator": "0.14.2",
    "class-transformer": "0.5.1",
    "zod": "4.1.12"
  },
  "logging": {
    "nestjs-pino": "4.3.0",
    "pino": "9.6.0",
    "pino-pretty": "13.1.0"
  },
  "testing": {
    "jest": "30.2.0",
    "@nestjs/testing": "11.1.7",
    "supertest": "7.1.4"
  }
}
```

#### æ¨¡å—æ¶æ„

```
apps/api/src/
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ auth/              # SIWE è®¤è¯ã€JWT ç­–ç•¥
â”‚   â”œâ”€â”€ products/          # äº§å“ (SKU) CRUD
â”‚   â”œâ”€â”€ policy/            # ä¿å•ç®¡ç†ã€ç­¾åå­˜å‚¨
â”‚   â”œâ”€â”€ payment/           # æ”¯ä»˜éªŒè¯ã€åŒºå—é“¾æœåŠ¡
â”‚   â”œâ”€â”€ admin/             # åå°ç®¡ç†
â”‚   â”œâ”€â”€ settings/          # ç³»ç»Ÿé…ç½®
â”‚   â””â”€â”€ prisma/            # Prisma æœåŠ¡
â”œâ”€â”€ app.module.ts          # æ ¹æ¨¡å—
â””â”€â”€ main.ts                # åº”ç”¨å…¥å£
```

---

## 6. æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 6.1 è®¤è¯æ¨¡å— (Auth)

**è·¯å¾„**: `apps/api/src/modules/auth/`

#### èŒè´£

- ç”Ÿæˆ SIWE nonce
- éªŒè¯ SIWE ç­¾å (åŸºäº EIP-4361)
- ç­¾å‘ JWT token
- ç”¨æˆ·ä¿¡æ¯ç®¡ç†
- Admin Bearer Token éªŒè¯

#### å…³é”®ç»„ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `auth.service.ts` | SIWE éªŒè¯é€»è¾‘ã€ç”¨æˆ· CRUD |
| `jwt.strategy.ts` | Passport JWT ç­–ç•¥ |
| `jwt.guard.ts` | JWT è·¯ç”±å®ˆå« |
| `admin.guard.ts` | Admin è®¤è¯å®ˆå« |
| `siwe-nonce.dto.ts` | SIWE nonce è¯·æ±‚ DTO |
| `siwe-verify.dto.ts` | SIWE ç­¾åéªŒè¯ DTO |

#### API ç«¯ç‚¹

```http
POST   /api/auth/siwe/nonce           # è·å– nonce
POST   /api/auth/siwe/verify          # éªŒè¯ç­¾åå¹¶è·å– token
GET    /api/auth/siwe/me              # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ (éœ€ JWT)
```

#### SIWE æµç¨‹

```typescript
// 1. å‰ç«¯è¯·æ±‚ nonce
const { nonce } = await api.post('/api/auth/siwe/nonce', { walletAddress });

// 2. æ„é€  SIWE message
const message = new SiweMessage({
  domain: window.location.host,
  address: walletAddress,
  uri: window.location.origin,
  version: '1',
  chainId: 97,
  nonce,
});

// 3. ç”¨æˆ·ç­¾å
const signature = await signer.signMessage(message.prepareMessage());

// 4. åç«¯éªŒè¯
const { token } = await api.post('/api/auth/siwe/verify', { message, signature });
```

### 6.2 äº§å“æ¨¡å— (Products)

**è·¯å¾„**: `apps/api/src/modules/products/`

#### èŒè´£

- äº§å“ (SKU) CRUD
- æ´»è·ƒäº§å“æŸ¥è¯¢
- äº§å“è¯¦æƒ…è·å–

#### æ•°æ®ç»“æ„

```typescript
interface Product {
  id: string;                    // UUID
  name: string;                  // äº§å“åç§°
  chainId: number;               // é“¾ ID (97 = BSC Testnet)
  tokenAddress: string;          // æ”¯ä»˜ä»£å¸åœ°å€
  tokenSymbol: string;           // ä»£å¸ç¬¦å· (USDT, USDC, BNB)
  termDays: number;              // ä¿é™©æœŸé™ (å¤©)
  premiumAmt: Decimal;           // ä¿è´¹é‡‘é¢
  coverageAmt: Decimal;          // æ‰¿ä¿é‡‘é¢
  termsUrl?: string;             // æ¡æ¬¾ URL
  status: 'active' | 'inactive'; // çŠ¶æ€
}
```

#### API ç«¯ç‚¹

```http
GET    /api/products              # è·å–æ´»è·ƒäº§å“åˆ—è¡¨
GET    /api/products/:id          # è·å–å•ä¸ªäº§å“è¯¦æƒ…
```

### 6.3 ä¿å•æ¨¡å— (Policy)

**è·¯å¾„**: `apps/api/src/modules/policy/`

#### èŒè´£

- ä¿å•åˆ›å»º
- åˆåŒç­¾ç½² (æ‰‹å†™ç­¾å + åŠ å¯†ç­¾å)
- ä¿å•çŠ¶æ€ç®¡ç†
- æ”¯ä»˜ç¡®è®¤
- ä¿å•æŸ¥è¯¢

#### ä¿å•çŠ¶æ€æœº

```typescript
enum PolicyStatus {
  PENDING_UNDERWRITING = 'pending_underwriting',       // å¾…å®¡æ ¸
  APPROVED_AWAITING_PAYMENT = 'approved_awaiting_payment', // å·²æ‰¹å‡†ï¼Œç­‰å¾…æ”¯ä»˜
  ACTIVE = 'active',                                   // å·²æ¿€æ´»
  REJECTED = 'rejected',                               // å·²æ‹’ç»
  EXPIRED_UNPAID = 'expired_unpaid',                   // è¶…æ—¶æœªæ”¯ä»˜
  EXPIRED = 'expired',                                 // å·²è¿‡æœŸ
}
```

```mermaid
stateDiagram-v2
    [*] --> PENDING_UNDERWRITING: åˆ›å»ºä¿å•
    PENDING_UNDERWRITING --> APPROVED_AWAITING_PAYMENT: Admin æ‰¹å‡†
    PENDING_UNDERWRITING --> REJECTED: Admin æ‹’ç»
    APPROVED_AWAITING_PAYMENT --> ACTIVE: æ”¯ä»˜æˆåŠŸ
    APPROVED_AWAITING_PAYMENT --> EXPIRED_UNPAID: è¶…è¿‡ 24h
    ACTIVE --> EXPIRED: æ‰¿ä¿æœŸç»“æŸ
    REJECTED --> [*]
    EXPIRED_UNPAID --> [*]
    EXPIRED --> [*]
```

#### API ç«¯ç‚¹

```http
POST   /api/policy                      # åˆ›å»ºä¿å•
POST   /api/policy/contract-sign/:id    # ç­¾ç½²åˆåŒ
GET    /api/policy/:id                  # è·å–ä¿å•è¯¦æƒ…
POST   /api/policy/payment-confirm      # ç¡®è®¤æ”¯ä»˜
GET    /api/policy/countdown/:id        # è·å–æ”¯ä»˜å€’è®¡æ—¶
GET    /api/policy/my-policies          # è·å–å½“å‰ç”¨æˆ·ä¿å•åˆ—è¡¨
```

#### ç­¾åå­˜å‚¨æœåŠ¡

**è·¯å¾„**: `apps/api/src/modules/policy/signature-storage.service.ts`

```typescript
class SignatureStorageService {
  async saveSignatureImage(
    buffer: Buffer,
    mimeType: string,
    policyId: string,
  ): Promise<{ url: string; hash: string }> {
    // 1. ç¡®ä¿å­˜å‚¨ç›®å½•å­˜åœ¨
    await this.ensureStorageDir();

    // 2. ç”Ÿæˆæ–‡ä»¶å: {policyId}-{timestamp}.png
    const filename = `${policyId}-${Date.now()}.png`;
    const filepath = path.join(this.storageDir, filename);

    // 3. è®¡ç®— SHA256 å“ˆå¸Œ
    const hash = createHash('sha256').update(buffer).digest('hex');

    // 4. å†™å…¥æ–‡ä»¶
    await fs.writeFile(filepath, buffer);

    // 5. è¿”å› URL å’Œå“ˆå¸Œ
    return {
      url: `/uploads/signatures/${filename}`,
      hash,
    };
  }
}
```

### 6.4 æ”¯ä»˜æ¨¡å— (Payment)

**è·¯å¾„**: `apps/api/src/modules/payment/`

#### èŒè´£

- é“¾ä¸Šäº¤æ˜“éªŒè¯
- æ”¯ä»˜è®°å½•åˆ›å»º
- ä¿å•æ¿€æ´»

#### åŒºå—é“¾æœåŠ¡

**è·¯å¾„**: `apps/api/src/modules/payment/blockchain.service.ts`

```typescript
class BlockchainService {
  async verifyPayment(
    txHash: string,
    expectedFrom: string,
    expectedTo: string,
    expectedAmount: bigint,
    expectedTokenAddress?: string,
  ): Promise<boolean> {
    // 1. è·å–äº¤æ˜“ Receipt
    const receipt = await provider.getTransactionReceipt(txHash);

    // 2. è·å–äº¤æ˜“è¯¦æƒ…
    const tx = await provider.getTransaction(txHash);

    // 3. éªŒè¯äº¤æ˜“çŠ¶æ€
    if (receipt.status !== 1) return false;

    // 4. éªŒè¯åœ°å€å’Œé‡‘é¢
    if (tx.from.toLowerCase() !== expectedFrom.toLowerCase()) return false;
    if (tx.to?.toLowerCase() !== expectedTo.toLowerCase()) return false;
    if (tx.value !== expectedAmount) return false;

    return true;
  }
}
```

#### API ç«¯ç‚¹

```http
POST   /api/policy/payment-confirm    # ç¡®è®¤æ”¯ä»˜å¹¶æ¿€æ´»ä¿å•
```

### 6.5 ç®¡ç†å‘˜æ¨¡å— (Admin)

**è·¯å¾„**: `apps/api/src/modules/admin/`

#### èŒè´£

- ä¿å•å®¡æ ¸ (æ‰¹å‡† / æ‹’ç»)
- ä¿å•åˆ—è¡¨æŸ¥è¯¢ (åˆ†é¡µã€ç­›é€‰)
- ç»Ÿè®¡æ•°æ®æŸ¥è¯¢

#### API ç«¯ç‚¹

```http
GET    /api/admin/policies                # è·å–ä¿å•åˆ—è¡¨ (æ”¯æŒåˆ†é¡µå’Œç­›é€‰)
GET    /api/admin/policies/:id            # è·å–ä¿å•è¯¦æƒ…
POST   /api/admin/policies/:id/review     # å®¡æ ¸ä¿å•
```

#### å®¡æ ¸è¯·æ±‚

```typescript
interface ReviewPolicyDto {
  action: 'approve' | 'reject';
  reviewerNote?: string;
}
```

---

## 7. æ•°æ®æ¨¡å‹

### 7.1 Entity Relationship Diagram (ERD)

```mermaid
erDiagram
    USER ||--o{ POLICY : owns
    SKU ||--o{ POLICY : template
    POLICY ||--o{ PAYMENT : has

    USER {
        uuid id PK
        string walletAddress UK "é’±åŒ…åœ°å€"
        string nonce "SIWE nonce"
        string email
        string_array roles
        string status
        datetime createdAt
        datetime lastLoginAt
        datetime updatedAt
    }

    SKU {
        uuid id PK
        string name "äº§å“åç§°"
        int chainId "é“¾ ID"
        string tokenAddress "ä»£å¸åœ°å€"
        string tokenSymbol "ä»£å¸ç¬¦å·"
        int termDays "æœŸé™(å¤©)"
        decimal premiumAmt "ä¿è´¹"
        decimal coverageAmt "æ‰¿ä¿é‡‘é¢"
        string termsUrl "æ¡æ¬¾ URL"
        string status
        datetime createdAt
        datetime updatedAt
    }

    POLICY {
        uuid id PK
        uuid userId FK
        uuid skuId FK
        string walletAddress "æŠ•ä¿é’±åŒ…"
        decimal premiumAmt "ä¿è´¹"
        decimal coverageAmt "æ‰¿ä¿é‡‘é¢"
        string status "çŠ¶æ€"
        string contractHash "åˆåŒå“ˆå¸Œ"
        string userSig "ç”¨æˆ·ç­¾å"
        string signatureImageUrl "ç­¾åå›¾ç‰‡"
        string signatureHash "ç­¾åå“ˆå¸Œ"
        datetime signatureSignedAt
        string signatureIp
        string signatureUserAgent
        string signatureWalletAddress
        datetime paymentDeadline
        string reviewerNote
        datetime startAt
        datetime endAt
        datetime createdAt
        datetime updatedAt
    }

    PAYMENT {
        uuid id PK
        uuid policyId FK
        string txHash UK "äº¤æ˜“å“ˆå¸Œ"
        int chainId
        string tokenAddress
        string fromAddress
        string toAddress
        decimal amount
        boolean confirmed
        datetime createdAt
        datetime updatedAt
    }

    SETTING {
        uuid id PK
        string key UK "é…ç½®é”®"
        string value "é…ç½®å€¼"
        datetime createdAt
        datetime updatedAt
    }
```

### 7.2 Prisma Schema æ‘˜è¦

**å®Œæ•´ Schema è·¯å¾„**: `apps/api/prisma/schema.prisma`

#### å…³é”®çº¦æŸ

- **æ‰€æœ‰é‡‘é¢**: `Decimal(38, 18)` - é¿å…æµ®ç‚¹æ•°ç²¾åº¦é—®é¢˜
- **é’±åŒ…åœ°å€**: ç»Ÿä¸€å°å†™å­˜å‚¨
- **å”¯ä¸€ç´¢å¼•**: `walletAddress`, `txHash`, `setting.key`
- **çº§è”åˆ é™¤**: `onDelete: Cascade` (Policy â†’ Payment)

---

## 8. ä¸šåŠ¡æµç¨‹è¯¦è§£

### 8.1 ç”¨æˆ·æ³¨å†Œ/ç™»å½•æµç¨‹ (SIWE)

```mermaid
sequenceDiagram
    actor U as ç”¨æˆ·
    participant W as Web App
    participant WC as Reown AppKit
    participant API as API Server
    participant DB as PostgreSQL

    U->>W: è®¿é—® /auth/connect
    U->>W: ç‚¹å‡» "Connect Wallet"
    W->>WC: è°ƒç”¨ open()
    WC->>U: æ˜¾ç¤ºé’±åŒ…é€‰æ‹©å™¨
    U->>WC: é€‰æ‹©é’±åŒ…å¹¶æˆæƒ
    WC-->>W: è¿”å› address

    W->>API: POST /api/auth/siwe/nonce<br/>{walletAddress}
    API->>DB: UPSERT User<br/>ç”Ÿæˆæ–° nonce
    DB-->>API: {nonce}
    API-->>W: {nonce}

    W->>W: æ„é€  SIWE Message<br/>(domain, address, nonce, chainId)
    W->>WC: è¯·æ±‚ç­¾å personal_sign(message)
    WC->>U: é’±åŒ…å¼¹çª—è¯·æ±‚ç­¾å
    U->>WC: ç”¨æˆ·ç¡®è®¤ç­¾å
    WC-->>W: {signature}

    W->>API: POST /api/auth/siwe/verify<br/>{message, signature}
    API->>API: éªŒè¯ç­¾å<br/>æ£€æŸ¥ nonce æœ‰æ•ˆæ€§
    API->>DB: æ›´æ–° lastLoginAt<br/>ç”Ÿæˆæ–° nonce (é˜²é‡æ”¾)
    API-->>W: {token, address}

    W->>W: å­˜å‚¨ token åˆ°<br/>localStorage + authStore
    W->>U: é‡å®šå‘åˆ° /dashboard
```

**å…³é”®å®‰å…¨ç‚¹**:

1. **Nonce ä¸€æ¬¡æ€§**: æ¯æ¬¡éªŒè¯åç”Ÿæˆæ–° nonceï¼Œé˜²æ­¢é‡æ”¾æ”»å‡»
2. **Message å®Œæ•´æ€§**: åŒ…å« domainã€chainIdã€timestampï¼Œé˜²æ­¢é’“é±¼
3. **Token çŸ­æœŸæœ‰æ•ˆ**: JWT 15 åˆ†é’Ÿè¿‡æœŸï¼Œéœ€åˆ·æ–° token

### 8.2 ä¿å•è´­ä¹°å®Œæ•´æµç¨‹

```mermaid
sequenceDiagram
    actor U as ç”¨æˆ·
    participant W as Web App
    participant A as API Server
    participant DB as Database
    participant Admin as ç®¡ç†å‘˜
    participant BC as BSC Blockchain

    rect rgb(200, 230, 255)
    note right of U: é˜¶æ®µ 1: äº§å“é€‰æ‹©
    U->>W: è®¿é—® /products
    W->>A: GET /api/products
    A->>DB: SELECT * FROM Sku<br/>WHERE status='active'
    DB-->>A: SKU[]
    A-->>W: Product[]
    W->>U: æ˜¾ç¤ºäº§å“å¡ç‰‡
    end

    rect rgb(255, 240, 200)
    note right of U: é˜¶æ®µ 2: ä¿å•åˆ›å»º
    U->>W: ç‚¹å‡»äº§å“ â†’ å¡«å†™è¡¨å•<br/>(premium, coverage)
    W->>A: POST /api/policy<br/>{skuId, premiumAmt, coverageAmt}
    A->>A: éªŒè¯ JWT + é‡‘é¢èŒƒå›´
    A->>DB: INSERT INTO Policy<br/>status=PENDING_UNDERWRITING
    DB-->>A: Policy {id, ...}
    A-->>W: {policyId}
    W->>U: é‡å®šå‘ /policy/contract-sign/{id}
    end

    rect rgb(255, 200, 200)
    note right of U: é˜¶æ®µ 3: åˆåŒç­¾ç½²
    U->>W: é˜…è¯»åˆåŒæ¡æ¬¾
    U->>W: æ‰‹å†™ç­¾å (SignaturePad)
    U->>W: ç‚¹å‡» "Confirm" é”å®šç­¾å
    W->>W: è®¡ç®— contractHash<br/>SHA256(åˆåŒå†…å®¹)
    W->>WC: è¯·æ±‚ç­¾å contractHash
    WC->>U: é’±åŒ…å¼¹çª—
    U->>WC: ç¡®è®¤ç­¾å
    WC-->>W: {userSig}

    W->>W: å¯¼å‡ºç­¾åå›¾ç‰‡ Base64
    W->>A: POST /api/policy/contract-sign/{id}<br/>{contractPayload, userSig, signatureImageBase64}
    A->>A: éªŒè¯ userSig ç­¾å<br/>éªŒè¯ contractHash
    A->>A: è§£ç  Base64 â†’ Buffer
    A->>A: ä¿å­˜å›¾ç‰‡åˆ° uploads/<br/>è®¡ç®— SHA256 hash
    A->>DB: UPDATE Policy SET<br/>userSig, signatureImageUrl,<br/>signatureHash, signatureIp, ...
    DB-->>A: Success
    A-->>W: {success: true}
    W->>U: æ˜¾ç¤º"ç­¾ç½²æˆåŠŸ"
    end

    rect rgb(230, 230, 230)
    note right of Admin: é˜¶æ®µ 4: ç®¡ç†å‘˜å®¡æ ¸
    Admin->>AdminApp: è®¿é—® /admin/policies
    AdminApp->>A: GET /api/admin/policies?status=pending_underwriting
    A->>DB: SELECT * FROM Policy<br/>JOIN User, Sku
    DB-->>A: Policy[]
    A-->>AdminApp: Policy[]

    Admin->>AdminApp: ç‚¹å‡»ä¿å• â†’ æŸ¥çœ‹è¯¦æƒ…<br/>(æŸ¥çœ‹ç­¾åå›¾ç‰‡/å…ƒæ•°æ®)
    Admin->>AdminApp: ç‚¹å‡» "Approve"
    AdminApp->>A: POST /api/admin/policies/{id}/review<br/>{action: 'approve'}
    A->>DB: UPDATE Policy SET<br/>status=APPROVED_AWAITING_PAYMENT<br/>paymentDeadline=now()+24h
    DB-->>A: Success
    A-->>AdminApp: {success: true}
    AdminApp->>Admin: æ˜¾ç¤º"å·²æ‰¹å‡†"
    end

    rect rgb(200, 255, 200)
    note right of U: é˜¶æ®µ 5: é“¾ä¸Šæ”¯ä»˜
    W->>U: é€šçŸ¥"ä¿å•å·²æ‰¹å‡†ï¼Œè¯·æ”¯ä»˜"
    U->>W: è®¿é—® /policy/payment/{id}
    W->>A: GET /api/settings/public/treasury_address
    A->>DB: SELECT value FROM Setting<br/>WHERE key='treasury_address'
    DB-->>A: {value: '0x123...'}
    A-->>W: {treasuryAddress}

    U->>W: ç‚¹å‡» "Pay Now"
    W->>BC: transfer(treasury, premium)
    BC->>U: é’±åŒ…å¼¹çª—
    U->>BC: ç¡®è®¤äº¤æ˜“
    BC-->>W: {txHash}

    W->>A: POST /api/policy/payment-confirm<br/>{policyId, txHash}
    A->>BC: eth_getTransactionReceipt(txHash)
    BC-->>A: {status, from, to, value, ...}
    A->>A: éªŒè¯ from=user, to=treasury<br/>éªŒè¯ value=premium
    A->>DB: UPSERT Payment<br/>{txHash, confirmed=true}
    A->>DB: UPDATE Policy SET<br/>status=ACTIVE<br/>startAt=now, endAt=now+termDays
    DB-->>A: Success
    A-->>W: {success: true, payment}

    W->>U: é‡å®šå‘ /policy/success/{id}
    end
```

### 8.3 æ”¯ä»˜å€’è®¡æ—¶æœºåˆ¶

```typescript
// apps/api/src/modules/policy/policy.service.ts
async approvePolicy(policyId: string) {
  const paymentDeadline = new Date();
  paymentDeadline.setHours(paymentDeadline.getHours() + 24);

  await this.prisma.policy.update({
    where: { id: policyId },
    data: {
      status: PolicyStatus.APPROVED_AWAITING_PAYMENT,
      paymentDeadline,
    },
  });
}

// å®šæ—¶ä»»åŠ¡ (cron job) - æ£€æŸ¥è¶…æ—¶æœªæ”¯ä»˜
async expireUnpaidPolicies() {
  const now = new Date();
  await this.prisma.policy.updateMany({
    where: {
      status: PolicyStatus.APPROVED_AWAITING_PAYMENT,
      paymentDeadline: { lte: now },
    },
    data: {
      status: PolicyStatus.EXPIRED_UNPAID,
    },
  });
}
```

---

## 9. æ‰‹å†™ç­¾åç³»ç»Ÿ

### 9.1 æ¶æ„æ¦‚è§ˆ

æ‰‹å†™ç­¾åç³»ç»Ÿæ˜¯ Cohe Capital çš„**æ ¸å¿ƒåˆè§„åŠŸèƒ½**ï¼Œç¡®ä¿ç”µå­åˆåŒçš„æ³•å¾‹æ•ˆåŠ›ã€‚

#### ç³»ç»Ÿç»„æˆ

1. **å‰ç«¯ç­¾åç»„ä»¶** (`SignaturePad.tsx`)
2. **åç«¯å­˜å‚¨æœåŠ¡** (`signature-storage.service.ts`)
3. **æ•°æ®åº“å…ƒæ•°æ®** (Policy è¡¨ç­¾åå­—æ®µ)
4. **é™æ€æ–‡ä»¶æœåŠ¡** (Nginx `/uploads` è·¯ç”±)

### 9.2 å‰ç«¯ç­¾åç»„ä»¶

**è·¯å¾„**: `apps/web/src/components/SignaturePad.tsx`

#### åŠŸèƒ½ç‰¹æ€§

- âœ… Canvas ç»˜åˆ¶ (æ”¯æŒé¼ æ ‡ + è§¦æ‘¸å±)
- âœ… ä¸‰æ€ç³»ç»Ÿ: æœªç­¾å â†’ å·²ç­¾å â†’ å·²ç¡®è®¤
- âœ… ç¡®è®¤åé”å®š (é˜²æ­¢ç¯¡æ”¹)
- âœ… å¯¼å‡º PNG Base64
- âœ… é«˜ DPI å±å¹•æ”¯æŒ (devicePixelRatio ç¼©æ”¾)

#### ç»„ä»¶ API

```typescript
interface SignaturePadHandle {
  isEmpty: () => boolean;          // æ£€æŸ¥æ˜¯å¦ä¸ºç©º
  isConfirmed: () => boolean;      // æ£€æŸ¥æ˜¯å¦å·²ç¡®è®¤
  clear: () => void;               // æ¸…ç©ºç­¾å
  getPNGDataURL: () => string;     // è·å– Base64
}

interface SignaturePadProps {
  onChange?: (signed: boolean) => void;      // ç­¾åçŠ¶æ€å˜åŒ–å›è°ƒ
  onConfirm?: (confirmed: boolean) => void;  // ç¡®è®¤çŠ¶æ€å˜åŒ–å›è°ƒ
  height?: number;                           // Canvas é«˜åº¦ (é»˜è®¤ 200px)
  className?: string;                        // è‡ªå®šä¹‰æ ·å¼
}
```

#### ä½¿ç”¨ç¤ºä¾‹

```tsx
const signaturePadRef = useRef<SignaturePadHandle>(null);

<SignaturePad
  ref={signaturePadRef}
  onChange={(signed) => setIsSigned(signed)}
  onConfirm={(confirmed) => setIsConfirmed(confirmed)}
  height={250}
/>

// æäº¤æ—¶
if (!signaturePadRef.current.isConfirmed()) {
  alert('è¯·ç¡®è®¤æ‚¨çš„ç­¾å');
  return;
}

const signatureBase64 = signaturePadRef.current.getPNGDataURL();
await api.post('/api/policy/contract-sign/:id', {
  signatureImageBase64: signatureBase64,
  ...
});
```

### 9.3 åç«¯å­˜å‚¨æœåŠ¡

**è·¯å¾„**: `apps/api/src/modules/policy/signature-storage.service.ts`

#### å­˜å‚¨ç­–ç•¥

**å½“å‰ (Demo ç¯å¢ƒ)**:
- æœ¬åœ°æ–‡ä»¶å­˜å‚¨: `uploads/signatures/`
- æ–‡ä»¶å‘½å: `{policyId}-{timestamp}.png`
- SHA256 å“ˆå¸Œæ ¡éªŒ
- Nginx é™æ€æ–‡ä»¶æœåŠ¡

**ç”Ÿäº§ç¯å¢ƒå»ºè®®**:
- Cloudflare R2 / AWS S3
- ç­¾å URL (æœ‰æ—¶æ•ˆæ€§)
- ç§æœ‰ Bucket + IAM æƒé™
- è‡ªåŠ¨å¤‡ä»½å’Œç‰ˆæœ¬æ§åˆ¶

#### å®ç°ä»£ç 

```typescript
@Injectable()
export class SignatureStorageService {
  private readonly storageDir = process.env.SIGNATURE_STORAGE_DIR || 'uploads/signatures';

  async saveSignatureImage(
    buffer: Buffer,
    mimeType: string,
    policyId: string,
  ): Promise<{ url: string; hash: string }> {
    // 1. ç¡®ä¿ç›®å½•å­˜åœ¨
    await this.ensureStorageDir();

    // 2. ç”Ÿæˆæ–‡ä»¶å
    const timestamp = Date.now();
    const filename = `${policyId}-${timestamp}.png`;
    const filepath = path.join(this.storageDir, filename);

    // 3. è®¡ç®—å“ˆå¸Œ
    const hash = createHash('sha256').update(buffer).digest('hex');

    // 4. å†™å…¥æ–‡ä»¶
    await fs.writeFile(filepath, buffer);

    // 5. è¿”å› URL
    return {
      url: `/uploads/signatures/${filename}`,
      hash,
    };
  }
}
```

### 9.4 å®‰å…¨ç‰¹æ€§

| ç‰¹æ€§ | å®ç°æ–¹å¼ |
|------|---------|
| **å®Œæ•´æ€§æ ¡éªŒ** | SHA256 å“ˆå¸Œå­˜å‚¨åˆ°æ•°æ®åº“ï¼Œç®¡ç†å‘˜å¯éªŒè¯ |
| **å®¡è®¡è¿½è¸ª** | è®°å½• IPã€User-Agentã€æ—¶é—´æˆ³ã€é’±åŒ…åœ°å€ |
| **é˜²ç¯¡æ”¹** | å‰ç«¯ç»„ä»¶ç¡®è®¤åé”å®šï¼Œåç«¯å“ˆå¸ŒéªŒè¯ |
| **è®¿é—®æ§åˆ¶** | ç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ç§æœ‰å­˜å‚¨ + ç­¾å URL |

### 9.5 æœªæ¥å¢å¼º

- [ ] **EIP-712 typed data ç­¾å**: å°†ç­¾åå…ƒæ•°æ®ä¸Šé“¾
- [ ] **æ—¶é—´æˆ³æœåŠ¡å™¨**: RFC 3161 å¯ä¿¡æ—¶é—´æˆ³
- [ ] **ç”µå­å°ç« **: ä¼ä¸šæ•°å­—è¯ä¹¦ç­¾å
- [ ] **æ³•å¾‹å­˜è¯**: å¯¹æ¥å¸æ³•åŒºå—é“¾å­˜è¯å¹³å°

---

## 10. åŒºå—é“¾é›†æˆ

### 10.1 æ”¯æŒçš„åŒºå—é“¾ç½‘ç»œ

| ç½‘ç»œ | Chain ID | RPC URL | ä»£å¸æ ‡å‡† | ç”¨é€” |
|------|----------|---------|---------|------|
| **BSC Testnet** | 97 | https://data-seed-prebsc-1-s1.binance.org:8545/ | BEP-20 | å¼€å‘æµ‹è¯• |
| **BSC Mainnet** | 56 | https://bsc-dataseed.binance.org/ | BEP-20 | ç”Ÿäº§ç¯å¢ƒ |

### 10.2 Web3 æŠ€æœ¯æ ˆ

#### å‰ç«¯ (Web App)

```typescript
// apps/web/src/config/web3.ts
import { createAppKit } from '@reown/appkit/react';
import { Ethers5Adapter } from '@reown/appkit-adapter-ethers';

const chains = [
  {
    chainId: 97,
    name: 'BSC Testnet',
    currency: 'tBNB',
    explorerUrl: 'https://testnet.bscscan.com',
    rpcUrl: 'https://data-seed-prebsc-1-s1.binance.org:8545/',
  },
];

const appKit = createAppKit({
  adapters: [new Ethers5Adapter()],
  networks: chains,
  projectId: process.env.NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID!,
});
```

#### åç«¯ (API)

```typescript
// apps/api/src/modules/payment/blockchain.service.ts
import { JsonRpcProvider } from 'ethers';

const provider = new JsonRpcProvider(
  'https://data-seed-prebsc-1-s1.binance.org:8545/'
);

// éªŒè¯äº¤æ˜“
const receipt = await provider.getTransactionReceipt(txHash);
```

### 10.3 é“¾ä¸Šæ“ä½œæµç¨‹

#### 10.3.1 é’±åŒ…è¿æ¥

```typescript
// ç”¨æˆ·ç‚¹å‡» "Connect Wallet"
import { useAppKitAccount } from '@reown/appkit/react';

const { address, isConnected } = useAppKitAccount();

if (isConnected) {
  console.log('é’±åŒ…åœ°å€:', address);
}
```

#### 10.3.2 SIWE ç­¾å

```typescript
import { BrowserProvider } from 'ethers';
import { SiweMessage } from 'siwe';

// 1. è·å– nonce
const { nonce } = await api.post('/api/auth/siwe/nonce', { walletAddress });

// 2. æ„é€  SIWE message
const message = new SiweMessage({
  domain: window.location.host,
  address: walletAddress,
  uri: window.location.origin,
  version: '1',
  chainId: 97,
  nonce,
  issuedAt: new Date().toISOString(),
});

// 3. è¯·æ±‚ç­¾å
const provider = new BrowserProvider(window.ethereum);
const signer = await provider.getSigner();
const signature = await signer.signMessage(message.prepareMessage());

// 4. éªŒè¯å¹¶è·å– token
const { token } = await api.post('/api/auth/siwe/verify', {
  message: message.prepareMessage(),
  signature,
});
```

#### 10.3.3 åˆåŒç­¾å

```typescript
// è®¡ç®—åˆåŒå“ˆå¸Œ
const contractHash = createHash('sha256')
  .update(JSON.stringify(contractPayload))
  .digest('hex');

// ç”¨æˆ·ç­¾åå“ˆå¸Œ
const provider = new BrowserProvider(window.ethereum);
const signer = await provider.getSigner();
const userSig = await signer.signMessage(contractHash);

// æäº¤åˆ°åç«¯
await api.post('/api/policy/contract-sign/:id', {
  contractPayload,
  userSig,
  signatureImageBase64,
});
```

#### 10.3.4 é“¾ä¸Šæ”¯ä»˜

```typescript
// æ–¹å¼ 1: åŸç”Ÿä»£å¸è½¬è´¦ (BNB)
const tx = await signer.sendTransaction({
  to: treasuryAddress,
  value: ethers.parseEther(premiumAmt.toString()),
});

// æ–¹å¼ 2: ERC-20/BEP-20 ä»£å¸è½¬è´¦ (USDT)
const contract = new Contract(tokenAddress, ERC20_ABI, signer);
const tx = await contract.transfer(
  treasuryAddress,
  ethers.parseUnits(premiumAmt.toString(), 18)
);

// ç­‰å¾…ç¡®è®¤
const receipt = await tx.wait();

// æäº¤åç«¯éªŒè¯
await api.post('/api/policy/payment-confirm', {
  policyId,
  txHash: receipt.hash,
});
```

### 10.4 æ™ºèƒ½åˆçº¦ (è§„åˆ’ä¸­)

#### PremiumCollector.sol

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/access/Ownable.sol";

contract PremiumCollector is Ownable {
    event PremiumReceived(
        address indexed payer,
        uint256 indexed policyId,
        address token,
        uint256 amount,
        uint256 timestamp
    );

    function purchasePolicy(
        uint256 policyId,
        address token,
        uint256 amount
    ) external {
        require(amount > 0, "Amount must be positive");

        IERC20(token).transferFrom(msg.sender, address(this), amount);

        emit PremiumReceived(
            msg.sender,
            policyId,
            token,
            amount,
            block.timestamp
        );
    }

    function withdraw(address token, uint256 amount) external onlyOwner {
        IERC20(token).transfer(owner(), amount);
    }
}
```

#### äº‹ä»¶ç›‘å¬ (åç«¯)

```typescript
// ç›‘å¬ PremiumReceived äº‹ä»¶è‡ªåŠ¨ç¡®è®¤æ”¯ä»˜
contract.on('PremiumReceived', async (payer, policyId, token, amount, timestamp) => {
  await this.paymentService.confirmPayment({
    policyId: policyId.toString(),
    txHash: event.transactionHash,
    amount: ethers.formatUnits(amount, 18),
  });
});
```

---

## 11. å®‰å…¨è®¾è®¡

### 11.1 è®¤è¯ä¸æˆæƒ

#### 11.1.1 ç”¨æˆ·è®¤è¯ (SIWE + JWT)

**æµç¨‹**:
1. SIWE nonce ç”Ÿæˆ (éšæœº UUID)
2. ç”¨æˆ·ç­¾å SIWE message
3. åç«¯éªŒè¯ç­¾å + nonce æœ‰æ•ˆæ€§
4. ç­¾å‘ JWT token (15 åˆ†é’Ÿè¿‡æœŸ)
5. æ¯æ¬¡éªŒè¯åç”Ÿæˆæ–° nonce (é˜²é‡æ”¾)

**å®‰å…¨ç‰¹æ€§**:
- âœ… Nonce ä¸€æ¬¡æ€§ä½¿ç”¨
- âœ… JWT çŸ­æœŸè¿‡æœŸ + Refresh Token
- âœ… é’±åŒ…åœ°å€ä¸€è‡´æ€§æ ¡éªŒ
- âœ… æ—¶é—´æˆ³é˜²é‡æ”¾ (5 åˆ†é’Ÿçª—å£)

#### 11.1.2 Admin è®¤è¯ (Bearer Token)

```typescript
// apps/api/src/modules/auth/admin.guard.ts
@Injectable()
export class AdminGuard implements CanActivate {
  canActivate(context: ExecutionContext): boolean {
    const request = context.switchToHttp().getRequest();
    const token = request.headers.authorization?.replace('Bearer ', '');

    const adminToken = process.env.ADMIN_TOKEN;
    if (!adminToken) throw new Error('ADMIN_TOKEN not configured');

    return token === adminToken;
  }
}
```

**ä½¿ç”¨**:
```typescript
@Controller('admin')
@UseGuards(AdminGuard)
export class AdminController {
  // æ‰€æœ‰è·¯ç”±éœ€è¦ Bearer Token
}
```

**ç”Ÿäº§ç¯å¢ƒæ”¹è¿›**:
- [ ] å®ç°åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC)
- [ ] Admin ç”¨æˆ·è¡¨ + JWT è®¤è¯
- [ ] æ“ä½œæ—¥å¿—å®¡è®¡

### 11.2 æ•°æ®éªŒè¯

#### 11.2.1 API å±‚éªŒè¯ (Zod)

```typescript
// apps/api/src/modules/policy/dto/create-policy.dto.ts
import { z } from 'zod';

export const createPolicySchema = z.object({
  skuId: z.string().uuid(),
  premiumAmt: z.string().regex(/^\d+(\.\d+)?$/),
  coverageAmt: z.string().regex(/^\d+(\.\d+)?$/),
});

export type CreatePolicyDto = z.infer<typeof createPolicySchema>;

// Controller
@Post()
async createPolicy(@Body() dto: CreatePolicyDto) {
  createPolicySchema.parse(dto); // è‡ªåŠ¨æŠ›å‡ºéªŒè¯é”™è¯¯
  // ...
}
```

#### 11.2.2 å‰ç«¯å±‚éªŒè¯ (react-hook-form + zod)

```typescript
// apps/web/src/app/policy/form/[productId]/page.tsx
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';

const policyFormSchema = z.object({
  premiumAmt: z.string().min(1, 'ä¿è´¹ä¸èƒ½ä¸ºç©º'),
  coverageAmt: z.string().min(1, 'æ‰¿ä¿é‡‘é¢ä¸èƒ½ä¸ºç©º'),
});

const form = useForm({
  resolver: zodResolver(policyFormSchema),
});
```

### 11.3 æ–‡ä»¶ä¸Šä¼ å®‰å…¨

#### 11.3.1 å½“å‰å®ç° (æœ¬åœ°å­˜å‚¨)

```typescript
// ç­¾åå›¾ç‰‡éªŒè¯
async saveSignatureImage(buffer: Buffer, mimeType: string) {
  // 1. æ£€æŸ¥ MIME ç±»å‹
  if (mimeType !== 'image/png') {
    throw new Error('Only PNG images are allowed');
  }

  // 2. æ£€æŸ¥æ–‡ä»¶å¤§å° (< 2MB)
  if (buffer.length > 2 * 1024 * 1024) {
    throw new Error('Image size exceeds 2MB');
  }

  // 3. è®¡ç®—å“ˆå¸Œ
  const hash = createHash('sha256').update(buffer).digest('hex');

  // 4. å®‰å…¨å­˜å‚¨
  await fs.writeFile(filepath, buffer);

  return { url, hash };
}
```

#### 11.3.2 ç”Ÿäº§ç¯å¢ƒå»ºè®® (S3/R2)

```typescript
import { S3Client, PutObjectCommand } from '@aws-sdk/client-s3';
import { getSignedUrl } from '@aws-sdk/s3-request-presigner';

async saveToS3(buffer: Buffer, filename: string) {
  const s3 = new S3Client({ region: 'us-east-1' });

  // ä¸Šä¼ åˆ°ç§æœ‰ Bucket
  await s3.send(new PutObjectCommand({
    Bucket: 'cohe-signatures',
    Key: `signatures/${filename}`,
    Body: buffer,
    ContentType: 'image/png',
    ServerSideEncryption: 'AES256',
    ACL: 'private', // ç§æœ‰è®¿é—®
  }));

  // ç”Ÿæˆ 1 å°æ—¶æœ‰æ•ˆçš„ç­¾å URL
  const url = await getSignedUrl(s3, new GetObjectCommand({
    Bucket: 'cohe-signatures',
    Key: `signatures/${filename}`,
  }), { expiresIn: 3600 });

  return url;
}
```

### 11.4 å®¡è®¡æ—¥å¿—

#### 11.4.1 Policy è¡¨å®¡è®¡å­—æ®µ

```prisma
model Policy {
  // ç­¾åå®¡è®¡
  signatureIp           String?    @db.VarChar(45)
  signatureUserAgent    String?
  signatureSignedAt     DateTime?
  signatureWalletAddress String?   @db.VarChar(42)

  // å®¡æ ¸å®¡è®¡
  reviewerNote          String?
  updatedAt             DateTime   @updatedAt
}
```

#### 11.4.2 å»ºè®®å¢å¼º (ç‹¬ç«‹å®¡è®¡è¡¨)

```prisma
model AuditLog {
  id            String   @id @default(uuid())
  userId        String?
  action        String   // 'policy.create', 'policy.sign', 'admin.review'
  resource      String   // 'Policy:uuid'
  ipAddress     String
  userAgent     String
  metadata      Json?    // é¢å¤–æ•°æ®
  createdAt     DateTime @default(now())

  @@index([userId, action])
  @@index([createdAt])
}
```

### 11.5 å®‰å…¨æœ€ä½³å®è·µæ¸…å•

- [x] **è¾“å…¥éªŒè¯**: Zod schema å…¨é“¾è·¯éªŒè¯
- [x] **è®¤è¯**: SIWE + JWT
- [x] **HTTPS**: ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ HTTPS
- [x] **CORS**: é…ç½®æ­£ç¡®çš„ origin
- [x] **Rate Limiting**: Nginx é™æµ (10-30 req/s)
- [x] **å®‰å…¨å¤´**: X-Frame-Options, CSP, X-Content-Type-Options
- [x] **SQL æ³¨å…¥é˜²æŠ¤**: Prisma å‚æ•°åŒ–æŸ¥è¯¢
- [x] **XSS é˜²æŠ¤**: React è‡ªåŠ¨è½¬ä¹‰ + DOMPurify (å¦‚éœ€)
- [ ] **CSRF ä¿æŠ¤**: SameSite cookies
- [ ] **ç§˜é’¥è½®æ¢**: å®šæœŸæ›´æ–° JWT_SECRET
- [ ] **ä¾èµ–æ‰«æ**: npm audit / Snyk
- [ ] **å®‰å…¨å®¡è®¡**: å®šæœŸæ¸—é€æµ‹è¯•

---

## 12. éƒ¨ç½²æ¶æ„

### 12.1 Docker Compose æ¶æ„

**é…ç½®æ–‡ä»¶**: `docker-compose.yml`

```yaml
services:
  # Nginx åå‘ä»£ç†
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./infra/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infra/nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - web
      - admin
      - api
    networks:
      - cohe-network

  # Web å‰ç«¯
  web:
    build:
      context: .
      dockerfile: apps/web/Dockerfile
    environment:
      - NEXT_PUBLIC_API_BASE=/api
      - NEXT_PUBLIC_CHAIN_ID=97
    networks:
      - cohe-network

  # Admin åå°
  admin:
    build:
      context: .
      dockerfile: apps/admin/Dockerfile
    environment:
      - NEXT_PUBLIC_ADMIN_API_BASE=/api
    networks:
      - cohe-network

  # API åç«¯
  api:
    build:
      context: .
      dockerfile: apps/api/Dockerfile
    environment:
      - DATABASE_URL=postgresql://user:pass@db:5432/cohe_capital
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - ./docker-volumes/uploads:/app/apps/api/uploads
    depends_on:
      - db
    networks:
      - cohe-network

  # PostgreSQL æ•°æ®åº“
  db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=cohe_user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=cohe_capital_db
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - cohe-network

networks:
  cohe-network:
    driver: bridge

volumes:
  postgres-data:
```

### 12.2 Nginx è·¯ç”±é…ç½®

**é…ç½®æ–‡ä»¶**: `infra/nginx/conf.d/default.conf`

```nginx
# Rate Limiting Zones
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=general_limit:10m rate=30r/s;

# Upstream æœåŠ¡
upstream web_upstream {
    server web:3000;
}

upstream admin_upstream {
    server admin:3002;
}

upstream api_upstream {
    server api:3001;
}

server {
    listen 80;
    server_name _;
    server_tokens off;

    # å®‰å…¨å¤´
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip å‹ç¼©
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    # Web å‰ç«¯
    location / {
        limit_req zone=general_limit burst=20 nodelay;
        proxy_pass http://web_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Admin åå°
    location /admin {
        limit_req zone=general_limit burst=20 nodelay;
        proxy_pass http://admin_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # API ç«¯ç‚¹
    location /api {
        limit_req zone=api_limit burst=10 nodelay;
        proxy_pass http://api_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # é™æ€æ–‡ä»¶ (ç­¾åå›¾ç‰‡)
    location /uploads {
        proxy_pass http://api_upstream;
    }

    # Swagger æ–‡æ¡£
    location /api-docs {
        proxy_pass http://api_upstream;
    }

    # å¥åº·æ£€æŸ¥
    location /health {
        access_log off;
        return 200 "healthy\n";
    }
}
```

### 12.3 Dockerfile å¤šé˜¶æ®µæ„å»º

**ç¤ºä¾‹**: `apps/api/Dockerfile`

```dockerfile
# Stage 1: ä¾èµ–å®‰è£…
FROM node:20-alpine AS deps
WORKDIR /app

RUN npm install -g pnpm@10.19.0

COPY pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/api/package.json ./apps/api/
COPY apps/api/prisma ./apps/api/prisma

RUN pnpm install --frozen-lockfile

# ç”Ÿæˆ Prisma Client
RUN cd apps/api && pnpm exec prisma generate

# Stage 2: æ„å»º
FROM node:20-alpine AS builder
WORKDIR /app

COPY --from=deps /app/node_modules ./node_modules
COPY apps/api ./apps/api

RUN cd apps/api && npm run build

# Stage 3: è¿è¡Œæ—¶
FROM node:20-alpine AS runner
WORKDIR /app

RUN apk add --no-cache dumb-init

# é root ç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nestjs

COPY --from=builder --chown=nestjs:nodejs /app/apps/api/dist ./dist
COPY --from=builder --chown=nestjs:nodejs /app/apps/api/node_modules ./node_modules
COPY --from=builder --chown=nestjs:nodejs /app/apps/api/prisma ./prisma

USER nestjs

EXPOSE 3001

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3001/healthz', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["dumb-init", "node", "dist/main.js"]
```

### 12.4 ç¯å¢ƒå˜é‡ç®¡ç†

**æ–‡ä»¶**: `.env.production`

```bash
# === æ•°æ®åº“ ===
DATABASE_URL=postgresql://cohe_user:${POSTGRES_PASSWORD}@db:5432/cohe_capital_db
POSTGRES_USER=cohe_user
POSTGRES_PASSWORD=<generated-password>
POSTGRES_DB=cohe_capital_db

# === JWT ===
JWT_SECRET=<openssl rand -base64 32>
JWT_EXPIRATION=15m
JWT_REFRESH_SECRET=<openssl rand -base64 32>
JWT_REFRESH_EXPIRATION=7d

# === SIWE ===
SIWE_DOMAIN=yourdomain.com
SIWE_URI=https://yourdomain.com

# === Admin ===
ADMIN_TOKEN=<openssl rand -hex 32>

# === åŒºå—é“¾ ===
NEXT_PUBLIC_CHAIN_ID=56  # BSC Mainnet
NEXT_PUBLIC_CHAIN_NAME=BSC Mainnet
NEXT_PUBLIC_WALLETCONNECT_PROJECT_ID=<your-project-id>

# === API ç«¯ç‚¹ ===
NEXT_PUBLIC_API_BASE=/api
NEXT_PUBLIC_ADMIN_API_BASE=/api

# === æ–‡ä»¶å­˜å‚¨ ===
SIGNATURE_STORAGE_DIR=uploads/signatures

# === CORS ===
CORS_ORIGIN=https://yourdomain.com

# === å…¶ä»– ===
NODE_ENV=production
PORT=3001
HOST=0.0.0.0
```

### 12.5 éƒ¨ç½²æµç¨‹

**è„šæœ¬**: `deploy.sh`

```bash
#!/bin/bash
set -e

echo "ğŸš€ Starting Cohe Capital deployment..."

# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. å®‰è£…ä¾èµ–
pnpm install --frozen-lockfile

# 3. æ•°æ®åº“è¿ç§»
cd apps/api
pnpm exec prisma migrate deploy
cd ../..

# 4. æ„å»º Docker é•œåƒ
docker-compose build --no-cache

# 5. åœæ­¢æ—§å®¹å™¨
docker-compose down

# 6. å¯åŠ¨æ–°å®¹å™¨
docker-compose up -d

# 7. å¥åº·æ£€æŸ¥
sleep 10
curl -f http://localhost/health || exit 1

echo "âœ… Deployment completed successfully!"
```

### 12.6 ç”Ÿäº§ç¯å¢ƒæ¸…å•

- [ ] **HTTPS è¯ä¹¦**: Let's Encrypt / Cloudflare SSL
- [ ] **åŸŸåé…ç½®**: DNS A è®°å½•æŒ‡å‘æœåŠ¡å™¨
- [ ] **ç¯å¢ƒå˜é‡**: æ‰€æœ‰ç§˜é’¥å·²æ›¿æ¢ä¸ºç”Ÿäº§å€¼
- [ ] **æ•°æ®åº“å¤‡ä»½**: æ¯æ—¥è‡ªåŠ¨å¤‡ä»½ + å¼‚åœ°å­˜å‚¨
- [ ] **ç›‘æ§å‘Šè­¦**: Sentry, Prometheus, Uptime Robot
- [ ] **æ—¥å¿—æ”¶é›†**: ELK Stack / Loki + Grafana
- [ ] **CI/CD**: GitHub Actions è‡ªåŠ¨éƒ¨ç½²
- [ ] **è´Ÿè½½æµ‹è¯•**: k6 / Artillery å‹åŠ›æµ‹è¯•
- [ ] **å®‰å…¨æ‰«æ**: OWASP ZAP, Snyk
- [ ] **ç¾éš¾æ¢å¤**: å¤‡ä»½æ¢å¤æ¼”ç»ƒ

---

## 13. å›½é™…åŒ–ä¸æœ¬åœ°åŒ–

### 13.1 æ”¯æŒè¯­è¨€

| è¯­è¨€ | ä»£ç  | è¦†ç›–ç‡ | æ–‡ä»¶è·¯å¾„ |
|------|------|--------|---------|
| **è‹±æ–‡** | `en` | 100% | `apps/web/src/locales/en.ts` |
| **ç¹ä½“ä¸­æ–‡** | `zh-TW` | 100% | `apps/web/src/locales/zh-TW.ts` |

### 13.2 å®ç°æ¶æ„

#### 13.2.1 è¯­è¨€åˆ‡æ¢å™¨ç»„ä»¶

**è·¯å¾„**: `apps/web/src/components/LanguageSwitcher.tsx`

```typescript
import { useLocaleStore } from '@/store/localeStore';

export function LanguageSwitcher() {
  const { locale, setLocale } = useLocaleStore();

  return (
    <select value={locale} onChange={(e) => setLocale(e.target.value)}>
      <option value="en">English</option>
      <option value="zh-TW">ç¹é«”ä¸­æ–‡</option>
    </select>
  );
}
```

#### 13.2.2 Zustand Store

**è·¯å¾„**: `apps/web/src/store/localeStore.ts`

```typescript
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { en } from '@/locales/en';
import { zhTW } from '@/locales/zh-TW';

interface LocaleStore {
  locale: 'en' | 'zh-TW';
  translations: typeof en;
  setLocale: (locale: 'en' | 'zh-TW') => void;
}

export const useLocaleStore = create<LocaleStore>()(
  persist(
    (set) => ({
      locale: 'en',
      translations: en,
      setLocale: (locale) =>
        set({
          locale,
          translations: locale === 'en' ? en : zhTW,
        }),
    }),
    { name: 'locale-storage' }
  )
);
```

#### 13.2.3 ç¿»è¯‘æ–‡ä»¶ç»“æ„

**ç¤ºä¾‹**: `apps/web/src/locales/en.ts`

```typescript
export const en = {
  common: {
    appName: 'COHE.CAPITL',
    loading: 'Loading...',
    submit: 'Submit',
    // ...
  },
  auth: {
    connectWallet: 'Connect Wallet',
    signatureRequired: 'Signature Required',
    // ...
  },
  dashboard: {
    welcome: 'Welcome',
    totalCoverage: 'Total Coverage',
    // ...
  },
  // ... æ›´å¤šå‘½åç©ºé—´
};
```

#### 13.2.4 ä½¿ç”¨æ–¹å¼

```tsx
// é¡µé¢ç»„ä»¶
const { translations: t } = useLocaleStore();

<h1>{t.dashboard.welcome}</h1>
<button>{t.common.submit}</button>
<p>{t.auth.connectWallet}</p>
```

### 13.3 æœªæ¥æ‰©å±•

- [ ] **æ—¥è¯­** (ja-JP)
- [ ] **éŸ©è¯­** (ko-KR)
- [ ] **è¥¿ç­ç‰™è¯­** (es-ES)
- [ ] **æ•°å­—æ ¼å¼åŒ–**: Intl.NumberFormat
- [ ] **æ—¥æœŸæ ¼å¼åŒ–**: dayjs locale
- [ ] **è´§å¸ç¬¦å·**: æ ¹æ®è¯­è¨€åˆ‡æ¢ $ / Â¥ / â‚¬
- [ ] **RTL æ”¯æŒ**: é˜¿æ‹‰ä¼¯è¯­ / å¸Œä¼¯æ¥è¯­

---

## 14. ç›‘æ§ä¸æ—¥å¿—

### 14.1 æ—¥å¿—ç³»ç»Ÿ

#### 14.1.1 åç«¯æ—¥å¿— (Pino)

**é…ç½®**: `apps/api/src/main.ts`

```typescript
import { Logger } from 'nestjs-pino';

const app = await NestFactory.create<NestFastifyApplication>(
  AppModule,
  adapter,
  { bufferLogs: true }
);

app.useLogger(app.get(Logger));
```

**æ—¥å¿—çº§åˆ«**:
- `debug`: è¯¦ç»†è°ƒè¯•ä¿¡æ¯
- `info`: æ­£å¸¸ä¸šåŠ¡æ—¥å¿—
- `warn`: è­¦å‘Šä¿¡æ¯
- `error`: é”™è¯¯ä¿¡æ¯

**æ—¥å¿—æ ¼å¼** (JSON):
```json
{
  "level": 30,
  "time": 1705800000000,
  "pid": 1,
  "hostname": "api-container",
  "msg": "Signature saved: 123-1705800000000.png, hash: abc123...",
  "context": "SignatureStorageService"
}
```

#### 14.1.2 å‰ç«¯æ—¥å¿— (Console)

```typescript
// ç”Ÿäº§ç¯å¢ƒå»ºè®®é›†æˆ Sentry
if (process.env.NODE_ENV === 'production') {
  Sentry.init({
    dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
    environment: 'production',
  });
}
```

### 14.2 å¥åº·æ£€æŸ¥

#### 14.2.1 API å¥åº·æ£€æŸ¥

**è·¯å¾„**: `apps/api/src/app.controller.ts`

```typescript
@Controller()
export class AppController {
  @Get('healthz')
  healthCheck() {
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
    };
  }
}
```

#### 14.2.2 Docker Healthcheck

```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3001/healthz', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"
```

#### 14.2.3 Nginx å¥åº·æ£€æŸ¥

```nginx
location /health {
    access_log off;
    return 200 "healthy\n";
    add_header Content-Type text/plain;
}
```

### 14.3 æ€§èƒ½ç›‘æ§ (å»ºè®®)

#### 14.3.1 Prometheus + Grafana

```typescript
// apps/api/src/app.module.ts
import { PrometheusModule } from '@willsoto/nestjs-prometheus';

@Module({
  imports: [
    PrometheusModule.register({
      path: '/metrics',
      defaultMetrics: {
        enabled: true,
      },
    }),
  ],
})
export class AppModule {}
```

**æŒ‡æ ‡ç¤ºä¾‹**:
- `http_request_duration_seconds`: HTTP è¯·æ±‚è€—æ—¶
- `http_requests_total`: HTTP è¯·æ±‚æ€»æ•°
- `db_query_duration_seconds`: æ•°æ®åº“æŸ¥è¯¢è€—æ—¶
- `policy_created_total`: ä¿å•åˆ›å»ºæ€»æ•°

#### 14.3.2 Sentry é”™è¯¯è¿½è¸ª

```typescript
// apps/web/src/app/layout.tsx
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 1.0,
  environment: process.env.NODE_ENV,
});
```

### 14.4 æ—¥å¿—ç®¡ç†å»ºè®®

| å·¥å…· | ç”¨é€” | ä¼˜åŠ¿ |
|------|------|------|
| **Loki + Grafana** | æ—¥å¿—èšåˆä¸æŸ¥è¯¢ | è½»é‡çº§ã€ä¸ Prometheus é›†æˆ |
| **ELK Stack** | æ—¥å¿—åˆ†æä¸å¯è§†åŒ– | åŠŸèƒ½å¼ºå¤§ã€ç”Ÿæ€ä¸°å¯Œ |
| **CloudWatch Logs** | AWS ç¯å¢ƒæ—¥å¿— | åŸç”Ÿé›†æˆã€æ— éœ€é…ç½® |
| **Datadog** | APM + æ—¥å¿— + ç›‘æ§ | å…¨æ ˆå¯è§‚æµ‹æ€§ |

---

## 15. æµ‹è¯•ç­–ç•¥

### 15.1 å·²å®ç°æµ‹è¯•

#### 15.1.1 API å•å…ƒæµ‹è¯• (Jest)

**ç¤ºä¾‹**: `apps/api/src/modules/auth/auth.service.spec.ts`

```typescript
describe('AuthService', () => {
  let service: AuthService;
  let prismaService: PrismaService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        AuthService,
        {
          provide: PrismaService,
          useValue: mockPrismaService,
        },
      ],
    }).compile();

    service = module.get<AuthService>(AuthService);
  });

  it('should generate nonce for new user', async () => {
    const walletAddress = '0x123...';
    const result = await service.generateNonce(walletAddress);

    expect(result.nonce).toBeDefined();
    expect(result.nonce.length).toBeGreaterThan(0);
  });

  it('should verify valid SIWE signature', async () => {
    const message = '...';
    const signature = '0xabc...';

    const result = await service.verifySiweSignature(message, signature);

    expect(result.token).toBeDefined();
    expect(result.address).toBe('0x123...');
  });
});
```

#### 15.1.2 E2E æµ‹è¯•é…ç½®

**æ–‡ä»¶**: `apps/api/test/jest-e2e.json`

```json
{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}
```

### 15.2 æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

| å±‚çº§ | å½“å‰è¦†ç›–ç‡ | ç›®æ ‡è¦†ç›–ç‡ |
|------|-----------|-----------|
| **API å•å…ƒæµ‹è¯•** | ~30% | 80% |
| **API E2E æµ‹è¯•** | 0% | 60% |
| **Web ç»„ä»¶æµ‹è¯•** | 0% | 70% |
| **Admin ç»„ä»¶æµ‹è¯•** | 0% | 60% |
| **E2E æµè§ˆå™¨æµ‹è¯•** | 0% | ä¸»æµç¨‹è¦†ç›– |

### 15.3 æµ‹è¯•è®¡åˆ’

#### 15.3.1 API å•å…ƒæµ‹è¯• (å¾…å®Œå–„)

- [ ] `products.service.spec.ts` - äº§å“ CRUD
- [ ] `policy.service.spec.ts` - ä¿å•åˆ›å»ºã€ç­¾ç½²ã€çŠ¶æ€ç®¡ç†
- [ ] `payment.service.spec.ts` - æ”¯ä»˜éªŒè¯é€»è¾‘
- [ ] `blockchain.service.spec.ts` - é“¾ä¸Šäº¤æ˜“éªŒè¯
- [ ] `signature-storage.service.spec.ts` - ç­¾åå›¾ç‰‡å­˜å‚¨

#### 15.3.2 Web ç»„ä»¶æµ‹è¯• (å¾…å®ç°)

```typescript
// apps/web/src/components/SignaturePad.test.tsx
import { render, screen } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import SignaturePad from './SignaturePad';

describe('SignaturePad', () => {
  it('should render canvas element', () => {
    render(<SignaturePad />);
    const canvas = screen.getByRole('img', { name: /signature/i });
    expect(canvas).toBeInTheDocument();
  });

  it('should show confirm button after signing', async () => {
    const onChange = jest.fn();
    render(<SignaturePad onChange={onChange} />);

    // æ¨¡æ‹Ÿç­¾å
    const canvas = screen.getByRole('img');
    await userEvent.click(canvas);

    expect(onChange).toHaveBeenCalledWith(true);
    expect(screen.getByText('Confirm')).toBeInTheDocument();
  });
});
```

#### 15.3.3 E2E æµ‹è¯• (Playwright)

```typescript
// e2e/policy-purchase.spec.ts
import { test, expect } from '@playwright/test';

test('complete policy purchase flow', async ({ page }) => {
  // 1. è¿æ¥é’±åŒ…
  await page.goto('http://localhost:3000/auth/connect');
  await page.click('button:has-text("Connect Wallet")');
  // ... MetaMask äº¤äº’

  // 2. é€‰æ‹©äº§å“
  await page.goto('http://localhost:3000/products');
  await page.click('text=Crypto Wallet Protection');

  // 3. å¡«å†™è¡¨å•
  await page.fill('input[name="premiumAmt"]', '100');
  await page.fill('input[name="coverageAmt"]', '10000');
  await page.click('button:has-text("Create Policy")');

  // 4. ç­¾ç½²åˆåŒ
  await expect(page).toHaveURL(/\/policy\/contract-sign\/.+/);
  // ... ç­¾åæ“ä½œ
  await page.click('button:has-text("Confirm")');
  await page.click('button:has-text("Sign Contract")');

  // 5. æ”¯ä»˜
  await expect(page).toHaveURL(/\/policy\/payment\/.+/);
  await page.click('button:has-text("Pay Now")');
  // ... MetaMask äº¤æ˜“ç¡®è®¤

  // 6. æˆåŠŸé¡µé¢
  await expect(page).toHaveURL(/\/policy\/success\/.+/);
  await expect(page.locator('text=Policy Activated')).toBeVisible();
});
```

---

## 16. è·¯å¾„è§„åˆ’

### 16.1 çŸ­æœŸç›®æ ‡ (1-2 å‘¨)

#### Sprint: å®Œå–„ MVP æ ¸å¿ƒåŠŸèƒ½

- [ ] **ä¿å•è¯¦æƒ…é¡µ** (Issue #36)
  - æ˜¾ç¤ºä¿å•å®Œæ•´ä¿¡æ¯
  - æ”¯ä»˜å€’è®¡æ—¶æ˜¾ç¤º
  - ä¿å•çŠ¶æ€å¡ç‰‡

- [ ] **æ”¯ä»˜ç¡®è®¤ä¼˜åŒ–**
  - äº¤æ˜“çŠ¶æ€è½®è¯¢
  - å¤±è´¥é‡è¯•æœºåˆ¶
  - ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

- [ ] **Admin Panel å¢å¼º**
  - æ•°æ®ç»Ÿè®¡ Dashboard
  - æ‰¹é‡æ“ä½œ (æ‰¹é‡æ‰¹å‡†)
  - å¯¼å‡º CSV åŠŸèƒ½

### 16.2 ä¸­æœŸç›®æ ‡ (1 ä¸ªæœˆ)

#### Epic: æµ‹è¯•ä¸è´¨é‡ä¿éšœ

- [ ] **E2E æµ‹è¯•**
  - Playwright æµ‹è¯•æ¡†æ¶æ­å»º
  - ä¸»æµç¨‹æµ‹è¯•è¦†ç›– (ç™»å½• â†’ è´­ä¹° â†’ æ”¯ä»˜)
  - CI é›†æˆ

- [ ] **å•å…ƒæµ‹è¯•**
  - API æœåŠ¡å±‚æµ‹è¯•è¦†ç›– 80%
  - Web ç»„ä»¶æµ‹è¯•è¦†ç›– 70%

- [ ] **æ€§èƒ½ä¼˜åŒ–**
  - React Query ç¼“å­˜ç­–ç•¥ä¼˜åŒ–
  - Next.js å›¾ç‰‡ä¼˜åŒ–
  - API å“åº”æ—¶é—´ä¼˜åŒ– (< 200ms)

#### Epic: éƒ¨ç½²ä¸è¿ç»´

- [ ] **CI/CD æµæ°´çº¿**
  - GitHub Actions è‡ªåŠ¨æ„å»º
  - è‡ªåŠ¨æµ‹è¯• + ä»£ç æ£€æŸ¥
  - è‡ªåŠ¨éƒ¨ç½²åˆ° Staging

- [ ] **ç›‘æ§ä½“ç³»**
  - Sentry é”™è¯¯è¿½è¸ªé›†æˆ
  - Prometheus + Grafana æ€§èƒ½ç›‘æ§
  - Uptime Robot å¯ç”¨æ€§ç›‘æ§

- [ ] **æ–‡ä»¶å­˜å‚¨è¿ç§»**
  - Cloudflare R2 é›†æˆ
  - ç­¾å URL å®ç°
  - æ•°æ®è¿ç§»è„šæœ¬

### 16.3 é•¿æœŸç›®æ ‡ (2-3 ä¸ªæœˆ)

#### Epic: åŠŸèƒ½æ‰©å±•

- [ ] **æ™ºèƒ½åˆçº¦**
  - éƒ¨ç½² PremiumCollector.sol
  - äº‹ä»¶ç›‘å¬è‡ªåŠ¨åŒ–
  - é“¾ä¸Šä¿å•è®°å½•

- [ ] **å¤šé“¾æ”¯æŒ**
  - Ethereum Mainnet
  - Polygon
  - Arbitrum

- [ ] **é«˜çº§åŠŸèƒ½**
  - ä¿å•è½¬è®©
  - ä¿å•ç»­ä¿
  - ç†èµ”æµç¨‹
  - æ¨èå¥–åŠ±

#### Epic: ç”¨æˆ·ä½“éªŒ

- [ ] **ç§»åŠ¨ç«¯ä¼˜åŒ–**
  - PWA æ”¯æŒ
  - ç¦»çº¿ç¼“å­˜
  - æ¨é€é€šçŸ¥

- [ ] **æ€§èƒ½æå‡**
  - Redis ç¼“å­˜å±‚
  - CDN åŠ é€Ÿ
  - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

#### Epic: ä¼ä¸šçº§ç‰¹æ€§

- [ ] **é«˜å¯ç”¨æ¶æ„**
  - Kubernetes éƒ¨ç½²
  - å¤šåŒºåŸŸéƒ¨ç½²
  - è‡ªåŠ¨æ‰©å®¹

- [ ] **å®‰å…¨å¢å¼º**
  - WAF (Web Application Firewall)
  - DDoS é˜²æŠ¤
  - å®šæœŸå®‰å…¨å®¡è®¡

---

## 17. é™„å½•

### 17.1 æœ¯è¯­è¡¨

| æœ¯è¯­ | å…¨ç§° | è¯´æ˜ |
|------|------|------|
| **SIWE** | Sign-In with Ethereum | åŸºäº EIP-4361 çš„å»ä¸­å¿ƒåŒ–ç™»å½•æ ‡å‡† |
| **EIP-4361** | Ethereum Improvement Proposal 4361 | SIWE åè®®è§„èŒƒ |
| **JWT** | JSON Web Token | æ— çŠ¶æ€è®¤è¯ä»¤ç‰Œ |
| **BEP-20** | Binance Smart Chain Token Standard | BSC ä»£å¸æ ‡å‡† (ç±»ä¼¼ ERC-20) |
| **RPC** | Remote Procedure Call | åŒºå—é“¾èŠ‚ç‚¹é€šä¿¡åè®® |
| **SSR** | Server-Side Rendering | æœåŠ¡ç«¯æ¸²æŸ“ |
| **CSR** | Client-Side Rendering | å®¢æˆ·ç«¯æ¸²æŸ“ |
| **ORM** | Object-Relational Mapping | å¯¹è±¡å…³ç³»æ˜ å°„ (Prisma) |
| **DTO** | Data Transfer Object | æ•°æ®ä¼ è¾“å¯¹è±¡ |
| **API** | Application Programming Interface | åº”ç”¨ç¨‹åºæ¥å£ |
| **SDK** | Software Development Kit | è½¯ä»¶å¼€å‘å·¥å…·åŒ… |
| **CDN** | Content Delivery Network | å†…å®¹åˆ†å‘ç½‘ç»œ |
| **CI/CD** | Continuous Integration/Deployment | æŒç»­é›†æˆ/éƒ¨ç½² |
| **WAF** | Web Application Firewall | Web åº”ç”¨é˜²ç«å¢™ |

### 17.2 ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| **é¡¹ç›®æ€»è§ˆ** | `/README.md` | é¡¹ç›®ç®€ä»‹ã€å¿«é€Ÿå¼€å§‹ |
| **ç¼–ç è§„èŒƒ** | `/CODEX.md` | ä»£ç é£æ ¼ã€æ¶æ„åŸåˆ™ |
| **AI åä½œæŒ‡å—** | `/CLAUDE.md` | Claude Code ä½¿ç”¨è§„èŒƒ |
| **é¡¹ç›®çŠ¶æ€** | `/docs/project_state.md` | Epic è¿›åº¦è¿½è¸ª |
| **å˜æ›´æ—¥å¿—** | `/docs/CHANGELOG.md` | è¯¦ç»†å¼€å‘æ—¥å¿— (234KB) |
| **éƒ¨ç½²æŒ‡å—** | `/docs/DEPLOYMENT_GUIDE.md` | ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹ |
| **æœ¬åœ°å¼€å‘** | `/docs/LOCAL_DEVELOPMENT.md` | æœ¬åœ°ç¯å¢ƒæ­å»º |
| **API æ–‡æ¡£** | `/apps/api/README.md` | åç«¯ API è¯¦ç»†è¯´æ˜ |
| **Swagger æ–‡æ¡£** | `http://localhost:3001/api-docs` | åœ¨çº¿ API æ–‡æ¡£ |

### 17.3 å¤–éƒ¨èµ„æº

| èµ„æº | URL | è¯´æ˜ |
|------|-----|------|
| **SIWE è§„èŒƒ** | https://eips.ethereum.org/EIPS/eip-4361 | EIP-4361 å®Œæ•´è§„èŒƒ |
| **Reown AppKit** | https://docs.reown.com/appkit | WalletConnect v2 æ–‡æ¡£ |
| **Next.js æ–‡æ¡£** | https://nextjs.org/docs | Next.js 14 å®˜æ–¹æ–‡æ¡£ |
| **NestJS æ–‡æ¡£** | https://docs.nestjs.com | NestJS 11 å®˜æ–¹æ–‡æ¡£ |
| **Prisma æ–‡æ¡£** | https://www.prisma.io/docs | Prisma ORM æ–‡æ¡£ |
| **BSC æ–‡æ¡£** | https://docs.bnbchain.org | BSC å¼€å‘è€…æ–‡æ¡£ |
| **ethers.js** | https://docs.ethers.org/v6 | ethers.js v6 æ–‡æ¡£ |

### 17.4 æŠ€æœ¯æ”¯æŒ

| è”ç³»æ–¹å¼ | ä¿¡æ¯ |
|---------|------|
| **æŠ€æœ¯è´Ÿè´£äºº** | samztz |
| **GitHub ä»“åº“** | (ç§æœ‰ä»“åº“) |
| **é—®é¢˜è¿½è¸ª** | GitHub Issues |
| **æ–‡æ¡£æ›´æ–°** | æ¯å‘¨åŒæ­¥æœ€æ–°è¿›åº¦åˆ°ç™½çš®ä¹¦ |

---

## ğŸ“Œ ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¸»è¦å˜æ›´ |
|------|------|---------|
| **v1.0.0** | 2025-11-20 | åˆå§‹æ­£å¼ç‰ˆæœ¬ï¼ŒåŸºäºå®é™…ä»£ç åº“ç”Ÿæˆ |

---

**Â© 2025 Cohe Capital. All rights reserved.**

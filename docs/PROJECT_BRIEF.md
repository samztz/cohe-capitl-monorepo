# 🎯 COHE.CAPITL 项目简介

> **一句话**: Web3 保险 DApp 平台，支持钱包登录、在线购买、数字签约、链上支付
> **开发周期**: 30 天（2024/10/17 - 2025/11/16）
> **完成度**: 70.3% (26/37 任务)
> **代码量**: 17,500 行 TypeScript

---

## 👨‍💼 一人分饰四角

| 角色 | 我做了什么 |
|------|-----------|
| 🎨 **设计师** | UI/UX 设计、页面布局、交互流程 |
| 📋 **产品经理** | 需求分析、功能规划、业务流程设计 |
| 💻 **开发工程师** | 前端 Web + 管理后台 + 后端 API + 数据库 + 区块链集成 |
| 🚀 **运维工程师** | 数据库部署、环境配置、文档维护 |

---

## 🏗️ 系统架构

**三个核心应用**:
- **Web DApp (用户端)**: Next.js 14 + Reown AppKit - 钱包登录、购买保险、支付
- **Backend API (核心引擎)**: NestJS + Prisma + PostgreSQL - 业务逻辑、数据存储
- **Admin 管理后台**: Next.js 14 + shadcn/ui - 审核保单、监控系统

**技术栈**: TypeScript 全栈、区块链集成（Ethers.js）、BSC 链

---

## ⭐ 技术亮点

### 亮点 1: 钱包登录 (SIWE)
- **实现**: 集成 Reown AppKit + SIWE (EIP-4361) 标准，用户用钱包私钥签名消息即可登录
- **优势**: 零注册、零密码、30 秒完成登录，私钥永不离开用户设备

### 亮点 2: 数字合同签署
- **实现**: 对合同哈希（包含所有关键信息）进行钱包签名，保存签名到数据库
- **优势**: 防篡改（任何修改都会导致哈希变化）、可验证（第三方可验证签名真实性）、全流程数字化

### 亮点 3: 链上支付验证
- **实现**: 后端通过 BSC RPC 监听用户支付交易，自动验证四要素（发送地址、接收地址、金额、代币），验证通过自动激活保单
- **优势**: 实时（几分钟内自动激活）、防伪（链上数据不可篡改）、降本（无需人工对账）

### 亮点 4: 国际化支持 (i18n)
- **实现**: 替换了 800+ 处硬编码文案，支持英文和繁体中文，所有文案从语言包读取，动态参数替换
- **优势**: 用户可一键切换语言，易于扩展新语言

### 亮点 5: 多链支持
- **实现**: 将硬编码的网络 ID 改为从产品信息动态读取 `product.chainId`，支持不同产品部署在不同区块链
- **优势**: 同一平台可销售多条链的产品（BSC、Polygon、Arbitrum 等），扩展性强

---

## 🚧 技术难点与解决方案

### 难点 1: 状态机设计 - 保单的生命周期管理
- **挑战**: 保单从创建到结束有多个状态（草稿 → 待审核 → 待支付 → 已激活 → 已过期），如何确保状态流转正确？
- **解决方案**:
  - 使用 TypeScript 枚举严格定义状态
  - 后端校验状态转换规则（例如：已激活的保单不能退回待审核）
  - 前端根据状态动态显示操作按钮
- **取舍**: 在后端严格校验状态转换，前端简化逻辑（降低维护成本）

### 难点 2: 支付确认 - 如何防止重复激活
- **挑战**: 同一笔链上转账可能被多次提交确认，如何防止重复？
- **解决方案**:
  - 数据库约束：`txHash` 设为唯一索引
  - 业务逻辑：检查 `txHash` 是否已被使用
  - 状态检查：只有待支付状态才能激活
- **取舍**: 三重保护（数据库 + 业务逻辑 + 状态检查），暂不引入分布式锁（不需要高并发场景）

### 难点 3: 移动端 vs Web
- **挑战**: 最初计划做 React Native 移动 App，但遇到钱包集成复杂、App Store 审核周期长、用户下载门槛高等问题
- **解决方案**: 全面转向 Web DApp
- **理由**:
  - 用户直接通过浏览器访问，无需下载
  - Web 端钱包集成更成熟（Reown AppKit）
  - 开发效率更高，更新部署快
- **取舍**: 保留 Mobile 代码作为参考，集中资源在 Web 端

### 难点 4: 路由保护与认证状态同步
- **挑战**: 用户刷新页面时可能丢失认证状态，未登录用户可能访问受保护页面
- **解决方案**:
  - 实现 `useRequireAuth` Hook，统一处理认证检查
  - 使用 Zustand + localStorage 持久化认证状态
  - 根路由服务端重定向到登录页（零延迟）
- **优势**: 所有受保护页面统一处理，避免 UI 闪烁

### 难点 5: 前后端数据字段不一致
- **挑战**: 后端返回 `premiumAmt`、`coverageAmt`（数据库字段名），前端期望 `premiumAmount`、`coverageAmount`（业务语义）
- **解决方案**:
  - 在前端创建适配器（Adapter）函数，统一转换字段名
  - 保持后端 API 稳定，前端适配
- **取舍**: 前端承担适配工作，避免大规模修改后端和数据库

---

## 📊 数据与成果

| 指标 | 数值 |
|------|------|
| 代码总量 | 17,500 行 TypeScript |
| 文件数量 | 126 个 |
| API 接口 | 23 个 REST API |
| 功能完成度 | 70.3% (26/37 任务) |
| 开发周期 | 30 天 |

**完成的模块**:
- ✅ 后端基础与认证 (100%)
- ✅ 保单购买闭环 (100%)
- ✅ Admin 管理后台 (100%)
- 🟡 Web DApp 前端 (83%)

**待完成**:
- ⚪ 前后端联调测试
- ⚪ 部署与演示环境

---

## 🎬 演示流程 (15 分钟)

1. **用户端演示 (7 分钟)**
   - 钱包登录 (1 分钟)
   - 浏览产品 (1 分钟)
   - 填写保单 (2 分钟)
   - 签署合同 (2 分钟)
   - 支付保费 (1 分钟)

2. **管理员端演示 (5 分钟)**
   - 查看待审核列表 (1 分钟)
   - 审核通过 (1 分钟)
   - 数据统计 (1 分钟)
   - 数据库验证 (2 分钟)

3. **技术总结 (3 分钟)**
   - 展示代码结构
   - 技术栈说明
   - 未来规划

---

## 💡 给非技术人员的解释

- **钱包登录** = 微信扫码登录（但更安全，私钥不暴露）
- **智能合约** = 自动售货机（满足条件自动执行）
- **链上验证** = 银行流水 vs 区块链流水（公开、不可篡改、实时）
- **TypeScript** = 带合同的 JavaScript（编译时检查类型，减少错误）

---

## 🌟 项目价值

### 商业价值
- **降低信任成本**: 代码即规则，透明可验证
- **提升效率**: 传统 7-14 天 → 我们 1-2 天
- **覆盖新市场**: 服务加密货币持有者

### 技术价值
- **全栈架构实践**: 完整的现代 Web 应用开发流程
- **区块链集成经验**: 可复用到其他 Web3 项目
- **工程化能力**: Monorepo、TypeScript、代码规范

---

## 📚 参考资料

- [完整演示指南](./PROJECT_DEMO_GUIDE.md)
- [项目总览](../README.md)
- [开发进度](./project_state.md)
- [更新日志](./CHANGELOG.md)

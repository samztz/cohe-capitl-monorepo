# ============================================
# Docker Compose - æœ¬åœ°å¼€å‘ä¸“å±é…ç½®
# Cohe Capital Insurance Platform
# ============================================
#
# è¿™ä¸ªæ–‡ä»¶ä¼šè¢« docker compose è‡ªåŠ¨åŠ è½½ï¼ˆæ— éœ€ -f å‚æ•°ï¼‰
# åŒ…å«æ‰€æœ‰æœ¬åœ°å¼€å‘éœ€è¦çš„é…ç½®ï¼šç«¯å£æš´éœ²ã€çƒ­æ›´æ–°ã€è°ƒè¯•ç­‰
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   docker compose up -d
#     â†’ è‡ªåŠ¨åˆå¹¶ docker-compose.yml + docker-compose.override.yml
#
# ============================================

services:
  # ============================================
  # Database - æœ¬åœ°å¼€å‘é…ç½®
  # ============================================
  db:
    restart: unless-stopped

    # æœ¬åœ°å¼€å‘ï¼šæš´éœ²ç«¯å£ç”¨äº Prisma Studioã€pgAdmin ç­‰å·¥å…·
    ports:
      - "${DB_PORT:-5432}:5432"

  # ============================================
  # Database Initialization - æœ¬åœ°å¼€å‘é…ç½®
  # ============================================
  db-init:
    # æœ¬åœ°å¼€å‘ï¼šè¿ç§» + è‡ªåŠ¨ç§å­æ•°æ®
    environment:
      NODE_ENV: development
    command: >
      sh -c "
        echo 'ğŸš€ Running Prisma migrations...' &&
        cd /app/apps/api &&
        pnpm prisma migrate deploy &&
        echo 'âœ… Database migrations completed successfully!' &&
        echo 'ğŸŒ± Seeding database with demo data...' &&
        export PRISMA_QUERY_ENGINE_LIBRARY=/app/apps/api/generated/prisma/libquery_engine-linux-musl-openssl-3.0.x.so.node &&
        node prisma/seed.js &&
        echo 'âœ… Database seed completed!'
      "

  # ============================================
  # API - æœ¬åœ°å¼€å‘é…ç½®
  # ============================================
  api:
    restart: unless-stopped

    environment:
      # æœ¬åœ°å¼€å‘æ¨¡å¼
      NODE_ENV: development

    # æœ¬åœ°å¼€å‘ï¼šæš´éœ²ç«¯å£ç”¨äºç›´æ¥è®¿é—®å’Œè°ƒè¯•
    ports:
      - "${API_PORT:-3001}:${API_PORT:-3001}"

    # å¯é€‰ï¼šçƒ­æ›´æ–°é…ç½®ï¼ˆå¦‚æœä½¿ç”¨ volumes æŒ‚è½½æºç ï¼‰
    # volumes:
    #   - ./apps/api/src:/app/apps/api/src
    #   - ./packages:/app/packages

  # ============================================
  # Web - æœ¬åœ°å¼€å‘é…ç½®
  # ============================================
  web:
    restart: unless-stopped

    environment:
      # æœ¬åœ°å¼€å‘æ¨¡å¼
      NODE_ENV: development

    # æœ¬åœ°å¼€å‘ï¼šæš´éœ²ç«¯å£ç”¨äºç›´æ¥è®¿é—®
    ports:
      - "${WEB_PORT:-3000}:${WEB_PORT:-3000}"

    # å¯é€‰ï¼šNext.js çƒ­æ›´æ–°ç«¯å£ï¼ˆå¦‚æœéœ€è¦ï¼‰
    # - "${WEB_DEV_PORT:-24678}:24678"

    # å¯é€‰ï¼šçƒ­æ›´æ–°é…ç½®
    # volumes:
    #   - ./apps/web/src:/app/apps/web/src
    #   - ./apps/web/pages:/app/apps/web/pages
    #   - ./apps/web/public:/app/apps/web/public

  # ============================================
  # Admin - æœ¬åœ°å¼€å‘é…ç½®
  # ============================================
  admin:
    restart: unless-stopped

    environment:
      # æœ¬åœ°å¼€å‘æ¨¡å¼
      NODE_ENV: development

    # æœ¬åœ°å¼€å‘ï¼šæš´éœ²ç«¯å£ç”¨äºç›´æ¥è®¿é—®
    ports:
      - "${ADMIN_PORT:-3002}:${ADMIN_PORT:-3002}"

    # å¯é€‰ï¼šçƒ­æ›´æ–°é…ç½®
    # volumes:
    #   - ./apps/admin/src:/app/apps/admin/src
    #   - ./apps/admin/pages:/app/apps/admin/pages
    #   - ./apps/admin/public:/app/apps/admin/public

  # ============================================
  # Nginx - æœ¬åœ°å¼€å‘é…ç½®
  # ============================================
  nginx:
    restart: unless-stopped

    # æœ¬åœ°å¼€å‘ï¼šæš´éœ² HTTP ç«¯å£
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"

# ============================================
# æœ¬åœ°å¼€å‘è¯´æ˜
# ============================================
#
# 1. æ‰€æœ‰æœåŠ¡ç«¯å£éƒ½æš´éœ²åˆ°å®¿ä¸»æœºï¼Œæ–¹ä¾¿è°ƒè¯•
# 2. NODE_ENV=development å¯ç”¨å¼€å‘æ¨¡å¼
# 3. restart: unless-stopped ç¡®ä¿æœåŠ¡è‡ªåŠ¨é‡å¯
# 4. å¦‚éœ€æºç çƒ­æ›´æ–°ï¼Œå–æ¶ˆæ³¨é‡Š volumes é…ç½®
#
# è®¿é—®åœ°å€ï¼š
#   Web:      http://localhost:3000  (æˆ– http://localhost/ é€šè¿‡ Nginx)
#   Admin:    http://localhost:3002
#   API:      http://localhost:3001/api
#   API Docs: http://localhost:3001/api-docs
#   Database: localhost:5432 (Prisma Studio, pgAdmin)
#

# ============================================
# Docker Compose - ç”Ÿäº§ç¯å¢ƒä¸“å±é…ç½®
# Cohe Capital Insurance Platform
# ============================================
#
# è¿™ä¸ªæ–‡ä»¶åŒ…å«ç”Ÿäº§ç¯å¢ƒçš„å®‰å…¨å’Œæ€§èƒ½ä¼˜åŒ–é…ç½®
# å¿…é¡»æ˜¾å¼æŒ‡å®šæ‰ä¼šè¢«åŠ è½½ï¼ˆè¦†ç›– override.ymlï¼‰
#
# ä½¿ç”¨æ–¹å¼ï¼š
#   æœ¬åœ°æ¨¡æ‹Ÿç”Ÿäº§ï¼ˆå‹æµ‹ï¼‰:
#     docker compose -f docker-compose.yml -f docker-compose.prod.yml up
#
#   ç”Ÿäº§æœåŠ¡å™¨éƒ¨ç½²:
#     docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# ============================================

services:
  # ============================================
  # Database - ç”Ÿäº§å®‰å…¨é…ç½®
  # ============================================
  db:
    restart: always

    # ç”Ÿäº§ç¯å¢ƒï¼šç¦æ­¢ç«¯å£æš´éœ²ï¼ˆä»… Docker å†…éƒ¨ç½‘ç»œè®¿é—®ï¼‰
    ports: []

    # å¯é€‰ï¼šèµ„æºé™åˆ¶ï¼ˆæ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´ï¼‰
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '2'
    #       memory: 2G
    #     reservations:
    #       cpus: '1'
    #       memory: 1G

  # ============================================
  # API - ç”Ÿäº§æ€§èƒ½é…ç½®
  # ============================================
  api:
    restart: always

    environment:
      # å¼ºåˆ¶ç”Ÿäº§æ¨¡å¼
      NODE_ENV: production

      # ç”Ÿäº§ç¯å¢ƒï¼šä¸¥æ ¼çš„ CORS é…ç½®
      CORS_ORIGIN: ${CORS_ORIGIN:-https://yourdomain.com}

    # ç”Ÿäº§ç¯å¢ƒï¼šç¦æ­¢ç«¯å£æš´éœ²ï¼ˆä»…é€šè¿‡ Nginx è®¿é—®ï¼‰
    ports: []

    # å¯é€‰ï¼šèµ„æºé™åˆ¶
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

  # ============================================
  # Web - ç”Ÿäº§æ€§èƒ½é…ç½®
  # ============================================
  web:
    restart: always

    environment:
      # å¼ºåˆ¶ç”Ÿäº§æ¨¡å¼
      NODE_ENV: production

      # ç”Ÿäº§ç¯å¢ƒï¼šä¸æ³¨å…¥ NEXT_PUBLIC_API_PORTï¼Œå¼ºåˆ¶ä½¿ç”¨ç›¸å¯¹è·¯å¾„ /api
      # è¿™æ ·æµè§ˆå™¨ä¼šä½¿ç”¨åŒåŸŸåçš„ /apiï¼Œé€šè¿‡ Nginx è½¬å‘
      NEXT_PUBLIC_API_PORT: ""

    # ç”Ÿäº§ç¯å¢ƒï¼šç¦æ­¢ç«¯å£æš´éœ²ï¼ˆä»…é€šè¿‡ Nginx è®¿é—®ï¼‰
    ports: []

    # å¯é€‰ï¼šèµ„æºé™åˆ¶
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '1'
    #       memory: 1G
    #     reservations:
    #       cpus: '0.5'
    #       memory: 512M

  # ============================================
  # Admin - ç”Ÿäº§æ€§èƒ½é…ç½®
  # ============================================
  admin:
    restart: always

    environment:
      # å¼ºåˆ¶ç”Ÿäº§æ¨¡å¼
      NODE_ENV: production

    # ç”Ÿäº§ç¯å¢ƒï¼šç¦æ­¢ç«¯å£æš´éœ²ï¼ˆä»…é€šè¿‡ Nginx è®¿é—®ï¼Œå»ºè®®ä½¿ç”¨å­åŸŸåï¼‰
    ports: []

    # å¯é€‰ï¼šèµ„æºé™åˆ¶
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '0.5'
    #       memory: 512M
    #     reservations:
    #       cpus: '0.25'
    #       memory: 256M

  # ============================================
  # Database Initialization - ç”Ÿäº§é…ç½®
  # ============================================
  db-init:
    restart: "no"  # ç”Ÿäº§ç¯å¢ƒï¼šè¿ç§»åªè¿è¡Œä¸€æ¬¡ï¼Œä¸è‡ªåŠ¨é‡å¯

    environment:
      NODE_ENV: production

  # ============================================
  # Nginx - ç”Ÿäº§ HTTPS é…ç½®
  # ============================================
  nginx:
    restart: always

    ports:
      # HTTPï¼ˆç”Ÿäº§ç¯å¢ƒé€šå¸¸é‡å®šå‘åˆ° HTTPSï¼‰
      - "${NGINX_HTTP_PORT:-80}:80"

      # HTTPSï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»å¯ç”¨ï¼‰
      # å–æ¶ˆæ³¨é‡Šå¹¶é…ç½® SSL è¯ä¹¦
      # - "${NGINX_HTTPS_PORT:-443}:443"

    # ç”Ÿäº§ç¯å¢ƒï¼šä½¿ç”¨å­åŸŸåéš”ç¦»çš„ Nginx é…ç½®
    # æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒå¼ºçƒˆå»ºè®®ä½¿ç”¨å­åŸŸåï¼ˆadmin.domain.comï¼‰è€Œéè·¯å¾„ï¼ˆ/adminï¼‰
    volumes:
      - ./infra/nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      # SSL è¯ä¹¦æŒ‚è½½ï¼ˆä½¿ç”¨ Let's Encrypt æˆ–å…¶ä»–è¯ä¹¦ï¼‰
      # - ./infra/nginx/certs:/etc/nginx/certs:ro
      # - ./infra/nginx/ssl-params.conf:/etc/nginx/ssl-params.conf:ro

    # å¯é€‰ï¼šèµ„æºé™åˆ¶
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '0.5'
    #       memory: 256M
    #     reservations:
    #       cpus: '0.25'
    #       memory: 128M

# ============================================
# ç”Ÿäº§ç¯å¢ƒé…ç½®æ¸…å•
# ============================================
#
# âœ… å¿…é¡»é…ç½®ï¼š
#   1. æ•°æ®åº“ç«¯å£ç¦æ­¢æš´éœ²ï¼ˆports: []ï¼‰
#   2. NODE_ENV=production æ‰€æœ‰æœåŠ¡
#   3. restart: always æ‰€æœ‰æœåŠ¡
#   4. ä½¿ç”¨å¼ºå¯†ç ï¼ˆ.env.productionï¼‰ï¼š
#      - JWT_SECRET (256-bit random)
#      - JWT_REFRESH_SECRET (256-bit random)
#      - POSTGRES_PASSWORD (strong password)
#      - ADMIN_TOKEN (strong token)
#   5. CORS é…ç½®ä¸ºå®é™…åŸŸå
#   6. SIWE_DOMAIN é…ç½®ä¸ºå®é™…åŸŸå
#
# ğŸ”’ å®‰å…¨å»ºè®®ï¼š
#   1. é…ç½® HTTPSï¼ˆSSL/TLS è¯ä¹¦ï¼‰
#   2. ä½¿ç”¨ .env.productionï¼ˆä¸æäº¤åˆ° gitï¼‰
#   3. å®šæœŸæ›´æ–° Docker é•œåƒ
#   4. é…ç½®é˜²ç«å¢™è§„åˆ™
#   5. å¯ç”¨æ—¥å¿—ç›‘æ§
#
# ğŸ“Š æ€§èƒ½ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰ï¼š
#   1. å–æ¶ˆæ³¨é‡Š deploy.resources é™åˆ¶
#   2. æ ¹æ®æœåŠ¡å™¨é…ç½®è°ƒæ•´ CPU/å†…å­˜
#   3. ç›‘æ§ï¼šdocker stats
#   4. æ—¥å¿—ï¼šdocker compose logs -f
#
# ğŸš€ éƒ¨ç½²æµç¨‹ï¼š
#   1. é…ç½® .env.productionï¼ˆä» .env.production.example å¤åˆ¶ï¼‰
#   2. æ„å»ºé•œåƒï¼šdocker compose -f docker-compose.yml -f docker-compose.prod.yml build
#   3. å¯åŠ¨æœåŠ¡ï¼šdocker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#   4. æ£€æŸ¥çŠ¶æ€ï¼šdocker compose ps
#   5. æŸ¥çœ‹æ—¥å¿—ï¼šdocker compose logs -f
#
